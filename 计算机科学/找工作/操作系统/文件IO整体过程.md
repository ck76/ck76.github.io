https://zhuanlan.zhihu.com/p/67192901

## 文件读写是计算机系统中非常重要的一个功能，读写过程是一个程序、操作系统、硬盘紧密协作的过程，涉及程序、缓存、文件系统、驱动、硬盘控制器、硬盘等多个方面，如图1所示，下面我们将分别从程序层、操作系统层、硬盘控制器层和硬盘层详细阐述三个文件IO过程。



![img](https://tva1.sinaimg.cn/large/0081Kckwly1glokozug53j30ed0ijdh8.jpg)



## 程序层I/O过程

程序是计算机的一组指令，经过编译和执行才能最终完成程序设计的动作，像TortoiseSVN这样的程序通常是由高级编程语言（如C/C++）编写而成，所以在程序层我们以函数调用的过程来详述其IO过程。

操作系统为了安全通常将分为用户态和内核态操作，程序层处于用户态，下面以C++写过程为例，如图2用户空间部分所示：

1. 当我们编辑完文件进行保存时，调用C++标准库中的输出流isotream进行输出。在输入输出流中为了更高效的处理IO，通常会使用缓冲区，缓冲区是作为IO中介的内存块，用于协调输入输出两端的速度。程序在调用输出后通常会将文件信息写入输出流的缓冲区中。
2. 当缓冲区满或程序主动调用了清空缓冲的操作时，就会调用操作系统的写操作，将指令和数据发送给操作系统进行输出操作。



![image-20201215152907337](https://tva1.sinaimg.cn/large/0081Kckwly1glokoylia4j30zb0u0n68.jpg)



图2 程序及操作系统层数据传输过程

## 操作系统层I/O过程

程序调用函数库时依然是在用户态，当调用操作系统的输出操作后就会从用户态转换到内核态，该过程就是系统调用过程。下面为Linux为例详述操作系统的操作。现代操作系统进行文件IO的操作主要由文件系统完成：

1. Linux遵循一切皆文件的原则，会将机器中所有硬件设备全部通过驱动、各位文件系统及VFS虚拟为文件，其实现的核心就是虚拟文件系统（Virtual File System，VFS）。VFS的作用就是采用标准的Unix系统调用读写位于不同物理介质上的不同文件系统。VFS是一个可以让open()、read()、write()等系统调用不用关心底层的存储介质和文件系统类型就可以工作的粘合层。一个Linux机器上可以挂载多种文件系统，但统一呈现为一个统一一致的操作接口。调用操作系统的输出操作实质就是对VFS调用输出操作，VFS会根据调用类型转换为调用不同的文件系统的输出操作，如文件IO对应ext3或ext4等文件系统IO。
2. 通常像ext3、ext4这样的文件系统也有自身的缓存机制，以匹配高速的程序处理过程和缓慢的硬盘读写过程。当文件信息写入文件系统的缓冲区后，内核有pdflush线程在不停的检测脏页，判断是否要写回到磁盘中。把需要写回的页提交到IO队列——即IO调度队列。由IO调度队列调度策略调度何时写回。当然也可以由程序主动调用强制刷新操作来完成缓冲区写入硬盘的操作。
3. 提到IO调度队列，不得不提一下磁盘结构磁头和电梯一样，尽量走到头再回来，避免来回抢占是跑，磁盘也是单向旋转，不会反复逆时针顺时针转的。IO队列有2个主要任务。一是合并相邻扇区的，而是排序。合并相信很容易理解，排序就是尽量按照磁盘选择方向和磁头前进方向排序。内核中有多种IO调度算法。当硬盘是SSD时候，没有什么磁道磁头，是随机读写的，加上这些调度算法反而画蛇添足。一般使用noop调度算法。
4. 从IO队列出来后，就到了驱动层，驱动层通过DMA，将数据写入磁盘cache。至于磁盘cache时候写入磁盘介质，那是磁盘控制器的事情。

## 硬盘控制器

1. 硬盘控制器简介

硬盘控制器即磁盘驱动器适配器。是计算机与磁盘驱动器的接口设备。它接收并解释计算机来的命令，向磁盘驱动器发出各种控制信号。检测磁盘驱动器状态，按照规定的磁盘数据格式，把数据写入磁盘和从磁盘读出数据。磁盘控制器类型很多，但它的基本组成和工作原理大体上是相同的，它主要由与计算机系统总线相连的控制逻辑电路，微处理器，完成读出数据分离和写入数据补偿的读写数据解码和编码电路，数据检错和纠错电路，根据计算机发来的命令对数据传递，串并转换以及格式化等进行控制的逻辑电路，存放磁盘基本输入输出程序的只读存储器和用以数据交换的缓冲区等部分组成。

目前所能见到的硬盘接口类型主要有IDE、SATA、SCSI、SAS、FC等等。IDE是俗称的并口，SATA是俗称的串口，这两种硬盘是个人电脑和低端服务器常见的硬盘。SCSI是"小型计算机系统专用接口"的简称，SCSI硬盘就是采用这种接口的硬盘，SAS就是串口的SCSI接口。一般服务器硬盘采用SATA和SAS这两类接口，其性能比上述两种硬盘要高，稳定性更强，但是价格高，噪音大。FC是光纤通道，和SCIS接口一样光纤通道最初也不是为硬盘设计开发的接口技术，是专门为网络系统设计的，但随着存储系统对速度的需求，才逐渐应用到硬盘系统中。SSD也称作电子硬盘或者固态电子盘，是由控制单元和固态存储单元（DRAM或FLASH芯片）组成的硬盘。固态硬盘的接口规范和定义、功能及使用方法上与普通硬盘的相同，在产品外形和尺寸上也与普通硬盘一致。

1. 磁盘控制器工作过程

磁盘控制器，顾名思义，是磁盘的控制设备。操作系统只需要关注磁盘控制器的类型和工作模式，不需要关注硬盘的信息，磁盘控制器在两者之间进行连接。驱动程序是硬件与系统之间的桥梁，系统通过驱动程序控制和管理硬件，并通过驱动程序发挥出硬件的最佳能力。而磁盘控制器驱动程序是系统与磁盘控制器之间的桥梁，系统通过磁盘控制器驱动管理磁盘控制器，又通过磁盘控制器管理磁盘。系统只要能够通过驱动操作磁盘控制器，那么对硬盘的管理完全由磁盘控制器承担。

现代的磁盘控制器和硬盘都内置固件（Firmware）进行，以实现复杂的驱动能力和连接。操作系统发出的操作和数据通过磁盘控制器驱动转化为磁盘控制器的操作和数据，磁盘控制器再根据指令发生硬盘操作指令并完成数据读写。

## 硬盘工作过程

1. **机械硬盘**
2. 硬盘结构

一般说来，机械硬盘由盘片、磁头、盘片主轴、控制电机、磁头控制器、数据转换器、接口、缓存等几个部份组成。如图5所示：



![img](https://tva1.sinaimg.cn/large/0081Kckwgy1glokobpeduj30bc08taar.jpg)



图5 硬盘平面图



![img](https://tva1.sinaimg.cn/large/0081Kckwgy1gloko9i58uj30760bmjrs.jpg)



图6 硬盘立体图

所有的盘片都固定在一个旋转轴上，这个轴即盘片主轴。而所有盘片之间是绝对平行的，在每个盘片的存储面上都有一个磁头，磁头与盘片之间的距离比头发 丝的直径还小。所有的磁头连在一个磁头控制器上，由磁头控制器负责各个磁头的运动。磁头可沿盘片的半径方向动作，（实际是斜切向运动），每个磁头同一时刻也必须是同轴的，即从正上方向下看，所有磁头任何时候都是重叠的（不过目前已经有多磁头独立技术，可不受此限制）。而盘片以每分钟数千转到上万转的速度在高速旋转，这样磁头就能对盘片上的指定位置进行数据的读写操作。磁头靠近主轴接触的表面，即线速度最小的地方，是一个特殊的区域，它不存放任何数据，称为启停区或着陆区（LandingZone），启停区外就是数据区。在最外圈，离主轴最远的地方是“0”磁道，硬盘数据的存放就是从最外圈开始的。那么，磁头是如何找到“0”磁道的位置的 呢？在硬盘中还有一个叫“0”磁道检测器的构件，它是用来完成硬盘的初始定位。

1. 机械硬盘存储原理

机械硬盘使用磁盘作为存储介质，以磁盘中磁性的方向变化来存储0和1这样的二进制数据；

1. 硬盘寻址

硬盘在逻辑上被划分为磁道、柱面以及扇区，并分别标记为盘面号、柱面号、扇区号：

盘面号：扇区所在的磁头（或盘面）

柱面号：磁道，确定磁头的径向方向

扇区号：在磁道上的位置，也叫块号，确定了数据在盘片圆圈上的位置。

确定磁盘地址（柱面号，磁头号，扇区号），内存地址（源/目）：

当需要从磁盘读写数据时，系统会将数据逻辑地址传给磁盘，磁盘的控制电路按照寻址逻辑将逻辑地址翻译成物理地址，即确定要读的数据在哪个磁道，哪个扇区。为了读写这个扇区的数据，需要将磁头放到这个扇区上方，为了实现这一点：1）首先必须找到柱面，即磁头需要移动对准相应磁道，这个过程叫做寻道，所耗费时间叫做寻道时间；2）然后目标扇区旋转到磁头下，即磁盘旋转将目标扇区旋转到磁头下。这个过程耗费的时间叫做旋转时间。

即一次访盘请求（读/写）完成过程由三个动作组成：

1）寻道（时间）：磁头移动定位到指定磁道

2）旋转延迟（时间）：等待指定扇区从磁头下旋转经过

3）数据传输（时间）：数据在磁盘与内存之间的实际传输

读写数据时通常还有一个额外的处理过程，在写数据之前会对数据计算ECC，并与数据一起写入扇区中，当读数据时会根据读取的ECC验证数据正确性。

1. 硬盘预读

由于存储介质的特性，磁盘本身存取就比主存慢很多，再加上机械运动耗费，磁盘的存取速度往往是主存的几百分分之一，因此为了提高效率，要尽量减少磁盘I/O。为了达到这个目的，磁盘往往不是严格按需读取，而是每次都会预读，即使只需要一个字节，磁盘也会从这个位置开始，顺序向后读取一定长度的数据放入内存。

1. 硬盘扇区划分

磁盘通常将512KB作为基本单元进行扇区划分，同时也作为操作的基本单元。早期硬盘结构比较简单，扇区划分时所有磁道划分同样数量的扇区，以内圈磁道为准，外圈磁道利用率低。现代磁盘为了充分利用外圈磁道，通常以512KB为单位对每个磁道进行连续划分。

磁盘交叉因子

采用连续扇区划分提高了磁道利用率，且随着硬盘转速提高，硬盘磁头在读写一个扇区后，磁盘要进行数据处理，磁头等待下一条读写指令，但磁盘依然在转动，当要执行下一条读写指令时磁头已经转过了物理上几个扇区，若要将数据在连续物理扇区中存储需要等待再次转到相应扇区地址才能操作，且不同磁道对应的线速度也不一致。为了提高磁盘读写速度，减少磁头等待时间，所以磁盘为每个磁道设定了不同的交叉因子（通常为1~5），即磁头在存储数据时不再使用物理上连续的扇区，而是间隔使用扇区，如写了第一个扇区，下次写的是第“1+交叉因子”扇区。

1. LBA->CHS

当驱动程序收到LBA地址后需要将其转化为CHS(cylinders-heads-sectors)地址，即磁柱-磁头-扇区)寻址模式，以硬盘上某个磁柱、磁头、扇区的硬件位置所合成的地址来指定。

1. 分区与扇区对应

为了便于管理文件或出于安全考虑，我们通常将硬盘进行分区，在机械硬盘中，系统分区与硬盘扇区存在一一对应关系，分区确定后，分区所使用的扇区也就确定了。分区中的文件与扇区也存在一定的对应关系，当文件创建后，所使用的扇区也就是确定了，当文件内容变化后也会修改相应扇区中的内容，即原地修改；文件增大会分配新的扇区，减小时会释放原有扇区。



1. **固态硬盘**

固态硬盘（Solid State Disk或Solid State Drive），也称作电子硬盘或者固态电子盘，是由控制单元和固态存储单元（DRAM或FLASH芯片）组成的硬盘。固态硬盘的接口规范和定义、功能及使用方法上与普通硬盘的相同，在产品外形和尺寸上也与普通硬盘一致。由于固态硬盘没有普通硬盘的旋转介质，因而抗震性极佳。其芯片的工作温度范围很宽（-40~85℃）。目前广泛应用于军事、车载、工控、视频监控、网络监控、网络终端、电力、医疗、航空等、导航设备等领域。目前由于成本较高，正在逐渐普及到DIY市场。固态硬盘的存储介质分为两种，一种是采用闪存（FLASH芯片）作为存储介质，另外一种是采用DRAM作为存储介质。

（1）基于闪存的固态硬盘（IDE FLASH DISK、Serial ATA Flash Disk）：

采用FLASH芯片作为存储介质，这也是我们通常所说的SSD。它的外观可以被制作成多种模样，例如：笔记本硬盘、微硬盘、存储卡、优盘等样式。这种SSD固态硬盘最大的优点就是可以移动，而且数据保护不受电源控制，能适应于各种环境，但是使用年限不高，适合于个人用户使用。

在基于闪存的固态硬盘中，存储单元又分为两类：SLC（Single Layer Cell 单层单元）和MLC（Multi-Level Cell多层单元）。SLC的特点是成本高、容量小、但是速度快，而MLC的特点是容量大成本低，但是速度慢。MLC的每个单元是2bit的，相对SLC来说整整多了一倍。不过，由于每个MLC存储单元中存放的资料较多，结构相对复杂，出错的几率会增加，必须进行错误修正，这个动作导致其性能大幅落后于结构简单的SLC闪存。此外，SLC闪存的优点是复写次数高达100000次，比MLC闪存高10倍。此外，为了保证MLC的寿命，控制芯片都校验和智能磨损平衡技术算法，使得每个存储单元的写入次数可以平均分摊，达到100万小时故障间隔时间(MTBF)。

（2）基于DRAM的固态硬盘：

采用DRAM作为存储介质，目前应用范围较窄。它仿效传统硬盘的设计、可被绝大部分操作系统的文件系统工具进行卷设置和管理，并提供工业标准的PCI和FC接口用于连接主机或者服务器。应用方式可分为SSD硬盘和SSD硬盘阵列两种。它是一种高性能的存储器，而且使用寿命很长，美中不足的是需要独立电源来保护数据安全。

（3）固态硬盘工作原理

在传统机械硬盘中，虽然磁盘控制器速度、硬盘容量都有很大提升，但限制于物理转速的特性，其读写速度并没有太多提升，而SSD硬盘完全随机读写，更性能与主控制器的相关性更大，其寿命与存储颗粒质量有关，而由于闪存颗粒集成度高，所以其容量完全可以超越机械硬盘。闪存是基本存储单元，而主控制器则是SSD的心脏，负责运算和任务分配，两者的结合才是一款SSD性能的真正体现。

1. NAND闪存页和块

闪存单元组织成为阵列，称为块，而块组织成为面。块中能够进行读写操作的最小单元是页。页不能独立擦除，只能整块擦除。NAND闪存页大的大小并不一致，大多数硬盘的页大小是2KB、4KB、8 KB 或16 KB。大多数SSD每个块有128或256个页。这即表示一个块的大小可能在256 KB 到4 MB之间。例如Samsung SSD 840 EVO的块大小是2048 KB，每块包括256页每页8KB。

1. 固态硬盘存储原理

与机械硬盘使用盘片和磁头进行数据存取不同，固态硬盘是一种使用NAND闪存来存储0和1信息的存储设备，内部实际为晶体管，使用电信号进行读写。所以在速度和稳定性上相比机械硬盘有很大提升。

1. 固态硬盘分区逻辑

在机械硬盘中，分区确定后，所能使用的扇区就确定了，分区与扇区一一对应，但在固态硬盘中不存在分区与存储芯片对应问题。固态硬盘的分区只是逻辑存在，其内部并没有分区，且也不是LBA与地址块一一对应，每次文件的写入都由主控制器根据“全盘损耗均衡”进行存储块选择分配。

1. 读是页对齐的

一次读取少于一页是不可能的。当然可以通过操作系统只请求一个直接，但SSD中会取回整个页，强制读取比所需多的多的数据。

1. 写是页对齐的

写入到SSD的时候，写入将补齐到页大小。所以即便写入操作只影响一字节，都会重写整个页。写入比所需更多的数据被称为写入放大。写入一个页也被称为“（编置to program）”一个页。

1. 页不能覆写

NAND闪存页只能在其为“空”的状态下进行写入。当数据改变，页的内容被复制到内部寄存器中，数据更新，然后新版本的数据将存储字啊一个”空“页中，这个操作被称为”读-改-写“。数据并非原地更新，因为”空”页并非原先存储数据的页。一旦数据被保存到硬盘上，原来的页将被标记为“废弃”，并一直保持这样直到被擦除。

1. 擦除是块对齐的

页不能被覆写，一旦页成为“废弃的”，让其重新空下来的方法是擦除它们。然而，独立擦除一个页是不可能的，并且只能一次擦除整个块。

1. 内部并行

在内部，数个层次的并行使得可以一次向不同NAND闪存芯片上写数个块的数据，这几个块被称为“簇”。

1. 损耗均衡

因为NAND闪存单元会损耗殆尽，FTL的一个主要目标是额能的将工作分散到各个单元上，这样块中的闪存单元可以在同一时间损坏。

1. 垃圾回收

SSD主控中的垃圾回收确保废弃的块能够擦除并重新变为空状态，使新进入的写入命令可以访问。

1. 绝不写入少于一页的数据

避免写入少于NAND闪存页大小的数据以最小化写入放大并避免读-改-写操作。目前一页最大为16KB，因此此值应该作为默认值使用。这个值取决于SSD型号，并且在将来SSD改进之后你可能需要增加。

1. 对齐写入

将写入对齐为页大小，写入数据块大小为页大小的倍数。

1. 小写入缓存化

为了最大化吞吐量，在任何可能的时候将小写入缓存到内存中，当缓存满了再进行一次大写入，这样来将小写入打包。

1. 为了提升读性能，将相关的数据写在一起。

读取性能取决于写入模式。当大数据块一次写入的时候，其将被分配到不同的NAND闪存芯片上。因此你需要将相关的数据写到相同的页、块、或簇上，这样在你之后读取的时候可以利用内部并行，用一个I/O请求更快的读取。

1. 分离读写请求

混合的小读写交叉的工作负载会妨碍内部缓存和预读取机制正常工作，并会导致吞吐量下降。最好的办法是避免同时发生的读操作和写操作，并将其以一个接一个的大数据块的形式实现，数据块大小推荐和簇大小相同。举个例子，如果要更新1000个文件，你可以遍历文件逐一读写，但会很慢。如果一次读取1000个文件然后一次写回1000个文件将会好很多。



1. **混合硬盘**

混合硬盘（SolidStateHybridDrive，SSHD）采用非易失性闪存和磁盘的混合存储形式，将非易失性闪存作为传统硬盘的缓存，利用其恒定快速的读取时间来改善磁盘的平均读取时间，以达到改善磁盘性能的目的。混合硬盘是一块基于传统机械硬盘诞生出来的新硬盘，除了机械硬盘必备的碟片、马达、磁头等等，还内置了NAND闪存颗粒，这颗颗粒将用户经常访问的数据进行储存，可以达到如SSD效果的读取性能。

工作方式一：SSD缓存加速技术

混合硬盘有两种工作方式，第一种工作方式将独立的SSD作为缓存。这个缓存相当于降低速度的内存，整个机械硬盘拥有固态硬盘的速度。



![img](https://pic2.zhimg.com/80/v2-3c40829a650f96ab57be6975d78f8601_1440w.jpg)


图7 混合硬盘的两种工作方式

英特尔智能加速技术、SSD厂家生产的SSD缓存盘均采用此项技术。它们将SSD依附在机械硬盘，用户手动或者程序自动把SSD建立一个加速缓冲区，为主体的机械硬盘提供缓存加速服务。但是这种技术有两个要命的地方，1、数据的稳定可靠性，SSD缓存全盘接收活动数据，而且需要快速擦写退出那些不用的数据，对SSD P/E寿命值快速消耗；2、它和内存一样关机之后数据消失。

工作方式二：缓存记忆技术

混合硬盘的另一种工作方式SSD缓存记忆技术，它把SSD作为记忆缓存，并非全盘接收全部活动的数据，而是有选择性的预存数据，因此它的使用寿命更长，更加安全。 它的工作原理是把频繁使用的各种应用、数据预存到SSD缓存，这个缓存具备学习和记忆功能，它预存的数据不会因为关机而消失。

希捷最早把SSD缓存记忆技术应用在混合硬盘，至今已三年有余，先后推出二代2.5英寸混合硬盘，第一代产品最大容量500GB，SSD闪存仅有4GB；第二代产品的硬盘和闪存容量均大幅提高，分别达到750GB和8GB。

Adaptive Memory技术实现自我学习，这项技术实际一种自学习算法，它使最常用的应用程序和文件能够提供类似SSD的响应。Adaptive Memory选择性地拷贝最频繁读取的数据，以及检索至闪存比较费时间的数据，协助闪存和机械硬盘之间的通信与数据智能。希捷的另一个关键技术－－“FAST Factor闪存管理”通过主控芯片可无缝集成硬件、固件和高速NAND闪存，同时能够在各种各样的配置条件下，通过任意操作系统和任意驱动程序，维护任意系统中的数据，实现快速的应用加载和类似SSD的总体系统响应速度。希捷将FAST Factor和Adaptive Memory两种技术相结合，能够创建即时响应、即时启动和即时满意的用户体验。　　

另外，即使用户关机，保存在混合硬盘闪存中的数据也不会丢失，除非进行格式化或碎片整理。和传统硬盘一样，用户仍然需要进行磁盘碎片整理，但这会让闪存中通过“学习”保存下来的缓存清零，因此对于这样的硬盘用户最好降低碎片整理的频率。