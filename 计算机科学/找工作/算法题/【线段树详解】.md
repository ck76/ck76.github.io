[TOC]

- https://leetcode.cn/problems/longest-increasing-subsequence-ii/solution/by-lfool-f6vs/

# [å¦‚æœæƒ³è¦æŸ¥çœ‹ä½œè€…æ›´å¤šæ–‡ç« ï¼Œå¯ä»¥ç‚¹å‡»æ­¤å¤„ï¼ï¼ï¼ğŸ”¥ğŸ”¥ğŸ”¥](https://leetcode.cn/link/?target=https%3A%2F%2Flfool.github.io%2FLFool-Notes%2F)

# [ä¸ºäº†æœ¬ç¯‡æ–‡ç« æ›´å¥½çš„è§‚æ„Ÿï¼Œå¯ä»¥ç‚¹å‡»æ­¤å¤„ï¼ï¼ï¼](https://leetcode.cn/link/?target=https%3A%2F%2Flfool.github.io%2FLFool-Notes%2Falgorithm%2Fçº¿æ®µæ ‘è¯¦è§£.html)

[729. æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ I](https://leetcode.cn/problems/my-calendar-i/)

[731. æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ II](https://leetcode.cn/problems/my-calendar-ii/)

[732. æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ III](https://leetcode.cn/problems/my-calendar-iii/)

[715. Range æ¨¡å—](https://leetcode.cn/problems/range-module/)

[307. åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„å¯ä¿®æ”¹](https://leetcode.cn/problems/range-sum-query-mutable/)

[933. æœ€è¿‘çš„è¯·æ±‚æ¬¡æ•°](https://leetcode.cn/problems/number-of-recent-calls/)

[699. æ‰è½çš„æ–¹å—](https://leetcode.cn/problems/falling-squares/)

[6206. æœ€é•¿é€’å¢å­åºåˆ— II](https://leetcode.cn/problems/longest-increasing-subsequence-ii/)

------

***å¦‚æœåªæƒ³çœ‹æœ¬é¢˜çš„è§£æ³•ï¼Œå¯ç›´æ¥è·³åˆ°æ–‡ç« æœ«å°¾ï¼Œæœ‰è¯¦ç»†åˆ†æè¿‡ç¨‹ï¼ï¼ğŸ”¥ğŸ”¥ğŸ”¥***

------

## çº¿æ®µæ ‘å¼•å…¥

é‡åˆ°è¿‡å¥½å¤šæ¬¡çº¿æ®µæ ‘çš„é¢˜ç›®ï¼Œè¦ä¹ˆå°±æ˜¯ç”¨å…¶ä»–çš„æ–¹æ³•å»è§£å†³ï¼Œè¦ä¹ˆå°±æ˜¯ä¸ä¼šå†™ï¼ï¼ä»Šå¤©ç—›å®šæ€ç—›ï¼Œå†³å®šå¥½å¥½å½’çº³æ•´ç†ä¸€ä¸‹çº¿æ®µæ ‘

**çº¿æ®µæ ‘è§£å†³çš„æ˜¯ã€ŒåŒºé—´å’Œã€çš„é—®é¢˜ï¼Œä¸”è¯¥ã€ŒåŒºé—´ã€ä¼šè¢«ä¿®æ”¹**

ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå¯¹äº `nums = [1, 2, 3, 4, 5]`

å¦‚æœæˆ‘ä»¬éœ€è¦å¤šæ¬¡æ±‚æŸäº›åŒºé—´çš„å’Œï¼Œæ˜¯ä¸æ˜¯é¦–å…ˆæƒ³åˆ°äº†åˆ©ç”¨ã€Œå‰ç¼€å’Œã€ã€‚**å…³äºå‰ç¼€å’Œçš„è¯¦ç»†ä»‹ç»å¯è§ [å‰ç¼€å’Œæ•°ç»„](https://leetcode.cn/link/?target=https%3A%2F%2Flfool.github.io%2FLFool-Notes%2Falgorithm%2Få‰ç¼€å’Œæ•°ç»„.html)**

ä½†æ˜¯å¦‚æœ `nums` ä¼šè¢«ä¿®æ”¹å‘¢ï¼Ÿæ¯”å¦‚ï¼š

- æŠŠç¬¬ `i` ä¸ªå…ƒç´ ä¿®æ”¹æˆ `x`
- æŠŠç¬¬ `i` ä¸ªå…ƒç´ å¢åŠ  `x`
- æŠŠåŒºé—´ `[i, j]` å†…çš„å…ƒç´ éƒ½å¢åŠ  `x`

æ­¤æ—¶ï¼Œå¦‚æœæˆ‘ä»¬å†ä½¿ç”¨ã€Œå‰ç¼€å’Œã€ï¼Œå°±æ²¡é‚£ä¹ˆé«˜æ•ˆäº†ã€‚å› ä¸ºæ¯ä¸€æ¬¡æ›´æ–°ï¼Œå‰ç¼€å’Œæ•°ç»„å¿…é¡»ä¹Ÿéšä¹‹æ›´æ–°ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º `O(n)`

æ—¢ç„¶ã€Œå‰ç¼€å’Œã€åœ¨è¿™ç§åœºæ™¯ä¸‹æ²¡é‚£ä¹ˆé«˜æ•ˆäº†ï¼Œæ‰€ä»¥å°±æœ‰äº†ä»Šå¤©è¦ä»‹ç»çš„ã€Œçº¿æ®µæ ‘ã€

## çº¿æ®µæ ‘åŸç†åŠå®ç°

ä¸Šé¢æåˆ°è¿‡ï¼š**çº¿æ®µæ ‘è§£å†³çš„æ˜¯ã€ŒåŒºé—´å’Œã€çš„é—®é¢˜ï¼Œä¸”è¯¥ã€ŒåŒºé—´ã€ä¼šè¢«ä¿®æ”¹**

æ‰€ä»¥**çº¿æ®µæ ‘**ä¸»è¦å®ç°ä¸¤ä¸ªæ–¹æ³•ï¼šã€Œæ±‚åŒºé—´å’Œã€&&ã€Œä¿®æ”¹åŒºé—´ã€ï¼Œä¸”æ—¶é—´å¤æ‚åº¦å‡ä¸º `O(logn)`

å§‹ç»ˆè®°ä½ä¸€å¥è¯ï¼š**çº¿æ®µæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªåŒºé—´**

`nums = [1, 2, 3, 4, 5]` å¯¹åº”çš„çº¿æ®µæ ‘å¦‚ä¸‹æ‰€ç¤ºï¼š

![1.svg](https://pic.leetcode-cn.com/1654588271-zbOpBr-1.svg)

![image-20220915100300150](https://tva1.sinaimg.cn/large/e6c9d24egy1h670i4kwhvj212e0hkwfk.jpg)

ä»å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»£è¡¨ä¸€ä¸ªåŒºé—´ï¼Œè€ŒèŠ‚ç‚¹çš„å€¼å°±æ˜¯è¯¥åŒºé—´çš„å’Œ (**å…¶å®è¿˜å¯ä»¥æ ¹æ®é¢˜ç›®é—®é¢˜ï¼Œæ”¹å˜è¡¨ç¤ºçš„å«ä¹‰ï¼ï¼**)

- æ•°å­—ä¹‹å’Œã€Œæ€»æ•°å­—ä¹‹å’Œ = å·¦åŒºé—´æ•°å­—ä¹‹å’Œ + å³åŒºé—´æ•°å­—ä¹‹å’Œã€
- æœ€å¤§å…¬å› æ•° (GCD)ã€Œæ€» GCD = gcd(å·¦åŒºé—´ GCD, å³åŒºé—´ GCD)ã€
- æœ€å¤§å€¼ã€Œæ€»æœ€å¤§å€¼ = max(å·¦åŒºé—´æœ€å¤§å€¼ï¼Œå³åŒºé—´æœ€å¤§å€¼)ã€

ä¸ç¬¦åˆåŒºé—´åŠ æ³•çš„ä¾‹å­ï¼š

- ä¼—æ•°ã€ŒåªçŸ¥é“å·¦å³åŒºé—´çš„ä¼—æ•°ï¼Œæ²¡æ³•æ±‚æ€»åŒºé—´çš„ä¼—æ•°ã€
- 01 åºåˆ—çš„æœ€é•¿è¿ç»­é›¶ã€ŒåªçŸ¥é“å·¦å³åŒºé—´çš„æœ€é•¿è¿ç»­é›¶ï¼Œæ²¡æ³•çŸ¥é“æ€»çš„æœ€é•¿è¿ç»­é›¶ã€

æ ¹èŠ‚ç‚¹ä»£è¡¨çš„åŒºé—´æ˜¯é—®é¢˜çš„æ€»åŒºé—´ï¼Œå¦‚è¿™ä¸ªä¾‹å­ï¼Œé—®é¢˜çš„æ€»åŒºé—´å°±æ˜¯æ•°ç»„çš„é•¿åº¦ `[0, 4]`

å…¶å®çº¿æ®µæ ‘æ˜¯ä¸€æ£µè¿‘ä¼¼çš„å®Œå…¨äºŒå‰æ ‘ï¼Œè¯¥ä¾‹å­å°±æ˜¯ä¸€æ£µå®Œå…¨äºŒå‰æ ‘ï¼Œä½†æ˜¯æœ‰äº›æƒ…å†µä¸æ˜¯å®Œå…¨äºŒå‰æ ‘

æ‰€ä»¥å¯¹äºç»™å®šçš„ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœè¯¥é—®é¢˜çš„èŒƒå›´æ˜¯ç¡®å®šçš„ï¼Œé‚£ä¹ˆè¯¥é—®é¢˜çš„çº¿æ®µæ ‘ä¹Ÿæ˜¯ç¡®å®šçš„ï¼Œå› ä¸ºå»ºç«‹çº¿æ®µæ ‘çš„è¿‡ç¨‹å°±æ˜¯ä¸æ–­æŠŠåŒºé—´ã€Œ**å¹³åˆ†**ã€çš„è¿‡ç¨‹ï¼Œç›´åˆ°åŒºé—´é•¿åº¦ä¸º 1

**æ³¨æ„ï¼šä¸‹é¢çš„æ‰€æœ‰å®ç°å‡åŸºäºæ±‚ã€ŒåŒºé—´å’Œã€ä»¥åŠå¯¹åŒºé—´è¿›è¡Œã€ŒåŠ å‡ã€çš„æ›´æ–°æ“ä½œ**

### çº¿æ®µæ ‘çš„æ•°æ®ç»“æ„

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ•°ç»„æ¥è¡¨ç¤ºä¸€æ£µçº¿æ®µæ ‘ï¼Œå‡å¦‚æ ¹èŠ‚ç‚¹ä¸º `i`ï¼Œé‚£ä¹ˆå·¦å­©å­çš„èŠ‚ç‚¹å°±ä¸º `2 * i`ï¼Œå³å­©å­çš„èŠ‚ç‚¹å°±ä¸º `2 * i + 1` (å‰æï¼š`i` ä» 1 å¼€å§‹)

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨é“¾è¡¨æ¥è¡¨ç¤ºä¸€æ£µçº¿æ®µæ ‘ï¼Œå…¶èŠ‚ç‚¹çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š

```java
class Node {
    // å·¦å³å­©å­èŠ‚ç‚¹
    Node left, right;
    // å½“å‰èŠ‚ç‚¹å€¼
    int val;
}
```

ä¸ªäººæ¯”è¾ƒå€¾å‘ä½¿ç”¨é“¾è¡¨ï¼Œå› ä¸ºæ¯”è¾ƒèŠ‚çº¦å†…å­˜ï¼Œä¸‹é¢çš„å®ç°å‡åŸºäºé“¾è¡¨

### çº¿æ®µæ ‘çš„å»ºç«‹

å¦‚æœé¢˜ç›®ä¸­ç»™äº†å…·ä½“çš„åŒºé—´èŒƒå›´ï¼Œæˆ‘ä»¬æ ¹æ®è¯¥èŒƒå›´å»ºç«‹çº¿æ®µæ ‘ã€‚**è§é¢˜ç›® [åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„å¯ä¿®æ”¹](https://leetcode.cn/problems/range-sum-query-mutable/)**

```java
public void buildTree(Node node, int start, int end) {
    // åˆ°è¾¾å¶å­èŠ‚ç‚¹
    if (start == end) {
        node.val = arr[start];
        return ;
    }
    int mid = (start + end) >> 1;
    buildTree(node.left, start, mid);
    buildTree(node.right, mid + 1, end);
    // å‘ä¸Šæ›´æ–°
    pushUp(node);
}
// å‘ä¸Šæ›´æ–°
private void pushUp(Node node) {
    node.val = node.left.val + node.right.val;
}
```

ä½†æ˜¯å¾ˆå¤šæ—¶å€™ï¼Œé¢˜ç›®ä¸­éƒ½æ²¡æœ‰ç»™å‡ºå¾ˆå…·ä½“çš„èŒƒå›´ï¼Œåªæœ‰æ•°æ®çš„å–å€¼èŒƒå›´ï¼Œä¸€èˆ¬éƒ½å¾ˆå¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬æ›´å¸¸ç”¨çš„æ˜¯ã€ŒåŠ¨æ€å¼€ç‚¹ã€

ä¸‹é¢æˆ‘ä»¬æ‰‹åŠ¨æ¨¡æ‹Ÿä¸€ä¸‹ã€ŒåŠ¨æ€å¼€ç‚¹ã€çš„è¿‡ç¨‹ã€‚åŒæ ·çš„ï¼Œä¹Ÿæ˜¯åŸºäºä¸Šé¢çš„ä¾‹å­ `nums = [1, 2, 3, 4, 5]`

å‡è®¾ä¸€ç§æƒ…å†µï¼Œæœ€å¼€å§‹åªçŸ¥é“æ•°ç»„çš„é•¿åº¦ `5`ï¼Œè€Œä¸çŸ¥é“æ•°ç»„å†…æ¯ä¸ªå…ƒç´ çš„å¤§å°ï¼Œå…ƒç´ éƒ½æ˜¯åé¢æ·»åŠ è¿›å»çš„ã€‚æ‰€ä»¥çº¿æ®µæ ‘çš„åˆå§‹çŠ¶æ€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š(åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¾ˆå­¤ç‹¬ï¼ï¼)

![1.svg](https://pic.leetcode-cn.com/1655808248-EfPSRV-1.svg)

å‡è®¾æ­¤æ—¶ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªå…ƒç´  `[2, 2]; val = 3`ã€‚ç°åœ¨çº¿æ®µæ ‘çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![2.svg](https://pic.leetcode-cn.com/1655808231-VTJvAM-2.svg)



![image-20220915100315716](https://tva1.sinaimg.cn/large/e6c9d24egy1h670ie9dk9j215i0kuabb.jpg)

è¿™é‡Œéœ€è¦è§£é‡Šä¸€ä¸‹ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰å·¦å³å­©å­ï¼Œä¼šä¸€ä¸‹å­æŠŠå·¦å³å­©å­èŠ‚ç‚¹éƒ½ç»™åˆ›å»ºå‡ºæ¥ï¼Œå¦‚ä¸Šå›¾æ©™è‰²èŠ‚ç‚¹æ‰€ç¤ºï¼Œå…·ä½“ä»£ç å¯è§æ–¹æ³• `pushDown()`

ä¸¤ä¸ªæ©™è‰²çš„å¶å­èŠ‚ç‚¹ä»…ä»…åªæ˜¯è¢«åˆ›å»ºå‡ºæ¥äº†ï¼Œå¹¶æ— å®é™…çš„å€¼ï¼Œå‡ä¸º 0ï¼›è€Œå¦å¤–ä¸€ä¸ªæ©™è‰²çš„éå¶å­èŠ‚ç‚¹ï¼Œå€¼ä¸º 3 çš„åŸå› æ˜¯ä¸‹é¢çš„å­©å­èŠ‚ç‚¹çš„å€¼å‘ä¸Šæ›´æ–°å¾—åˆ°çš„

ä¸‹é¢ç»™å‡ºä¾æ¬¡æ·»åŠ å‰©ä½™èŠ‚ç‚¹çš„è¿‡ç¨‹ï¼š**(æ³¨æ„è§‚å¯Ÿå€¼çš„å˜åŒ–ï¼ï¼)**

![3.svg](https://pic.leetcode-cn.com/1655808224-kMYiyq-3.svg)

![image-20220915100331287](https://tva1.sinaimg.cn/large/e6c9d24egy1h670io5o1dj21f10u0dji.jpg)

ã€ŒåŠ¨æ€å¼€ç‚¹ã€ä¸€èˆ¬æ˜¯åœ¨ã€Œæ›´æ–°ã€æˆ–ã€ŒæŸ¥è¯¢ã€çš„æ—¶å€™åŠ¨æ€çš„å»ºç«‹èŠ‚ç‚¹ï¼Œå…·ä½“å¯è§ä¸‹é¢çš„**æ›´æ–°**å’Œ**æŸ¥è¯¢**æ“ä½œ

### çº¿æ®µæ ‘çš„æ›´æ–°

æˆ‘çœ‹å¤§å¤šæ•°æ•™ç¨‹éƒ½æ˜¯æŠŠæ›´æ–°åˆ†ä¸ºä¸¤ç§ï¼šã€Œç‚¹æ›´æ–°ã€å’Œã€ŒåŒºé—´æ›´æ–°ã€ã€‚å…¶å®è¿™ä¸¤ç§å¯ä»¥åˆå¹¶æˆä¸€ç§ï¼Œã€Œç‚¹æ›´æ–°ã€ä¸å°±æ˜¯æ›´æ–°é•¿åº¦ä¸º 1 çš„åŒºé—´å˜›ï¼ï¼

æ›´æ–°åŒºé—´çš„å‰ææ˜¯æ‰¾åˆ°éœ€è¦æ›´æ–°çš„åŒºé—´ï¼Œæ‰€ä»¥å’ŒæŸ¥è¯¢çš„æ€è·¯å¾ˆç›¸ä¼¼

å¦‚æœæˆ‘ä»¬è¦æŠŠåŒºé—´ `[2, 4]` å†…çš„å…ƒç´ éƒ½ã€Œâ•1ã€

![3.svg](https://pic.leetcode-cn.com/1654588378-Bhkpkc-3.svg)

![image-20220915100341669](https://tva1.sinaimg.cn/large/e6c9d24egy1h670iu46ymj213k0igtad.jpg)

æˆ‘ä»¬ä¼šå‘ç°ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„ç°è±¡ï¼Œæˆ‘ä»¬åªæŠŠ `[2,2]` å’Œ `[3,4]` è¿™ä¸¤ä¸ªåŒºé—´å¯¹åº”çš„èŠ‚ç‚¹æ›´æ–°äº†ï¼Œè€ŒåŒºé—´ `[3, 3]` å’Œ `[4,4]` å¹¶æ²¡æœ‰æ›´æ–°

æŒ‰é“ç†æ¥è¯´ï¼Œ`[3, 3]` å’Œ `[4,4]` ä¹Ÿæ˜¯éœ€è¦æ›´æ–°çš„ï¼Œä¸ç„¶å½“æˆ‘ä»¬æŸ¥è¯¢åŒºé—´ `[3, 3]` å’Œ `[4,4]` çš„å€¼ï¼Œå°±ä¼šå‡ºç°é”™è¯¯ï¼ï¼

è¿™æ˜¯å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†ã€Œæ‡’æƒ°æ ‡è®°ã€çš„æ–¹æ³•ï¼Œæˆ‘ä»¬åªéœ€è¦æ›´æ–°åˆ°æ»¡è¶³æ¡ä»¶çš„åŒºé—´å³å¯ï¼Œç„¶åå†ç»™è¯¥åŒºé—´å¯¹åº”çš„èŠ‚ç‚¹åŠ ä¸€ä¸ªæ‡’æƒ°æ ‡è®°ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹æ‰€æœ‰å¯¹åº”çš„å­©å­èŠ‚ç‚¹éƒ½åº”è¯¥æœ‰æ­¤æ›´æ–°

å½“æˆ‘ä»¬å‘å­©å­èŠ‚ç‚¹éå†çš„æ—¶å€™ä¼šæŠŠã€Œæ‡’æƒ°æ ‡è®°ã€ä¸‹æ¨ç»™å­©å­èŠ‚ç‚¹

æˆ‘ä»¬éœ€è¦ç¨å¾®ä¿®æ”¹ä¸€ä¸‹ `Node` çš„æ•°æ®ç»“æ„

```java
class Node {
    // å·¦å³å­©å­èŠ‚ç‚¹
    Node left, right;
    // å½“å‰èŠ‚ç‚¹å€¼
    int val;
    // æ‡’æƒ°æ ‡è®°
    int add;
}
```

åŸºäºã€ŒåŠ¨æ€å¼€ç‚¹ã€çš„å‰æï¼Œæˆ‘ä»¬ä¸‹æ¨æ‡’æƒ°æ ‡è®°çš„æ—¶å€™ï¼Œå¦‚æœèŠ‚ç‚¹ä¸å­˜åœ¨å·¦å³å­©å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åˆ›å»ºå·¦å³å­©å­èŠ‚ç‚¹

å…ˆæ¥å®ç°ä¸‹æ¨æ‡’æƒ°æ ‡è®°çš„å‡½æ•°ï¼š

```java
// leftNum å’Œ rightNum è¡¨ç¤ºå·¦å³å­©å­åŒºé—´çš„å¶å­èŠ‚ç‚¹æ•°é‡
// å› ä¸ºå¦‚æœæ˜¯ã€ŒåŠ å‡ã€æ›´æ–°æ“ä½œçš„è¯ï¼Œéœ€è¦ç”¨æ‡’æƒ°æ ‡è®°çš„å€¼âœ–ï¸å¶å­èŠ‚ç‚¹çš„æ•°é‡
private void pushDown(Node node, int leftNum, int rightNum) {
    // åŠ¨æ€å¼€ç‚¹
    if (node.left == null) node.left = new Node();
    if (node.right == null) node.right = new Node();
    // å¦‚æœ add ä¸º 0ï¼Œè¡¨ç¤ºæ²¡æœ‰æ ‡è®°
    if (node.add == 0) return ;
    // æ³¨æ„ï¼šå½“å‰èŠ‚ç‚¹åŠ ä¸Šæ ‡è®°å€¼âœ–ï¸è¯¥å­æ ‘æ‰€æœ‰å¶å­èŠ‚ç‚¹çš„æ•°é‡
    node.left.val += node.add * leftNum;
    node.right.val += node.add * rightNum;
    // æŠŠæ ‡è®°ä¸‹æ¨ç»™å­©å­èŠ‚ç‚¹
    // å¯¹åŒºé—´è¿›è¡Œã€ŒåŠ å‡ã€çš„æ›´æ–°æ“ä½œï¼Œä¸‹æ¨æ‡’æƒ°æ ‡è®°æ—¶éœ€è¦ç´¯åŠ èµ·æ¥ï¼Œä¸èƒ½ç›´æ¥è¦†ç›–
    node.left.add += node.add;
    node.right.add += node.add;
    // å–æ¶ˆå½“å‰èŠ‚ç‚¹æ ‡è®°
    node.add = 0;
}
```

ä¸‹é¢æ¥å®ç°æ›´æ–°çš„å‡½æ•°ï¼š

```java
// åœ¨åŒºé—´ [start, end] ä¸­æ›´æ–°åŒºé—´ [l, r] çš„å€¼ï¼Œå°†åŒºé—´ [l, r] â• val
// å¯¹äºä¸Šé¢çš„ä¾‹å­ï¼Œåº”è¯¥è¿™æ ·è°ƒç”¨è¯¥å‡½æ•°ï¼šupdate(root, 0, 4, 2, 4, 1)
public void update(Node node, int start, int end, int l, int r, int val) {
    // æ‰¾åˆ°æ»¡è¶³è¦æ±‚çš„åŒºé—´
    if (l <= start && end <= r) {
        // åŒºé—´èŠ‚ç‚¹åŠ ä¸Šæ›´æ–°å€¼
        // æ³¨æ„ï¼šéœ€è¦âœ–ï¸è¯¥å­æ ‘æ‰€æœ‰å¶å­èŠ‚ç‚¹
        node.val += (end - start + 1) * val;
        // æ·»åŠ æ‡’æƒ°æ ‡è®°
        // å¯¹åŒºé—´è¿›è¡Œã€ŒåŠ å‡ã€çš„æ›´æ–°æ“ä½œï¼Œæ‡’æƒ°æ ‡è®°éœ€è¦ç´¯åŠ ï¼Œä¸èƒ½ç›´æ¥è¦†ç›–
        node.add += val;
        return ;
    }
    int mid = (start + end) >> 1;
    // ä¸‹æ¨æ ‡è®°
    // mid - start + 1ï¼šè¡¨ç¤ºå·¦å­©å­åŒºé—´å¶å­èŠ‚ç‚¹æ•°é‡
    // end - midï¼šè¡¨ç¤ºå³å­©å­åŒºé—´å¶å­èŠ‚ç‚¹æ•°é‡
    pushDown(node, mid - start + 1, end - mid);
    // [start, mid] å’Œ [l, r] å¯èƒ½æœ‰äº¤é›†ï¼Œéå†å·¦å­©å­åŒºé—´
    if (l <= mid) update(node.left, start, mid, l, r, val);
    // [mid + 1, end] å’Œ [l, r] å¯èƒ½æœ‰äº¤é›†ï¼Œéå†å³å­©å­åŒºé—´
    if (r > mid) update(node.right, mid + 1, end, l, r, val);
    // å‘ä¸Šæ›´æ–°
    pushUp(node);
}
```

### çº¿æ®µæ ‘çš„æŸ¥è¯¢

å¦‚æœæˆ‘ä»¬è¦æŸ¥è¯¢åŒºé—´ `[2, 4]` çš„ç»“æœï¼Œå¦‚ä¸‹å›¾çº¢è‰²æ ‡è®°æ‰€ç¤ºï¼š

<img src="https://pic.leetcode-cn.com/1654588328-LNnVpz-2.svg" alt="2.svg" style="zoom:53%;" />

<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h670jxx4aqj20zc0u0tap.jpg" alt="image-20220915100359797" style="zoom:30%;" />

<img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h670hlcfk7j211c0h0my8.jpg" alt="image-20220915100229595" style="zoom:50%;" />

ä¸‹é¢ç»™å‡ºä»£ç å®ç°ï¼š

```java
// åœ¨åŒºé—´ [start, end] ä¸­æŸ¥è¯¢åŒºé—´ [l, r] çš„ç»“æœï¼Œå³ [l ,r] ä¿æŒä¸å˜
// å¯¹äºä¸Šé¢çš„ä¾‹å­ï¼Œåº”è¯¥è¿™æ ·è°ƒç”¨è¯¥å‡½æ•°ï¼šquery(root, 0, 4, 2, 4)
public int query(Node node, int start, int end, int l, int r) {
    // åŒºé—´ [l ,r] å®Œå…¨åŒ…å«åŒºé—´ [start, end]
    // ä¾‹å¦‚ï¼š[2, 4] = [2, 2] + [3, 4]ï¼Œå½“ [start, end] = [2, 2] æˆ–è€… [start, end] = [3, 4]ï¼Œç›´æ¥è¿”å›
    if (l <= start && end <= r) return node.val;
    // æŠŠå½“å‰åŒºé—´ [start, end] å‡åˆ†å¾—åˆ°å·¦å³å­©å­çš„åŒºé—´èŒƒå›´
    // node å·¦å­©å­åŒºé—´ [start, mid]
    // node å·¦å­©å­åŒºé—´ [mid + 1, end]
    int mid = (start + end) >> 1, ans = 0;
    // ä¸‹æ¨æ ‡è®°
    pushDown(node, mid - start + 1, end - mid);
    // [start, mid] å’Œ [l, r] å¯èƒ½æœ‰äº¤é›†ï¼Œéå†å·¦å­©å­åŒºé—´
    if (l <= mid) ans += query(node.left, start, mid, l, r);
    // [mid + 1, end] å’Œ [l, r] å¯èƒ½æœ‰äº¤é›†ï¼Œéå†å³å­©å­åŒºé—´
    if (r > mid) ans += query(node.right, mid + 1, end, l, r);
    // ans æŠŠå·¦å³å­æ ‘çš„ç»“æœéƒ½ç´¯åŠ èµ·æ¥äº†ï¼Œä¸æ ‘çš„åç»­éå†åŒç†
    return ans;
}
```

## çº¿æ®µæ ‘å®Œæ•´æ¨¡ç‰ˆ

**æ³¨æ„ï¼šä¸‹é¢æ¨¡ç‰ˆåŸºäºæ±‚ã€ŒåŒºé—´å’Œã€ä»¥åŠå¯¹åŒºé—´è¿›è¡Œã€ŒåŠ å‡ã€çš„æ›´æ–°æ“ä½œï¼Œä¸”ä¸ºã€ŒåŠ¨æ€å¼€ç‚¹ã€**

```java
/**
 * @Description: çº¿æ®µæ ‘ï¼ˆåŠ¨æ€å¼€ç‚¹ï¼‰
 * @Author: LFool
 * @Date 2022/6/7 09:15
 **/
public class SegmentTreeDynamic {
    class Node {
        Node left, right;
        int val, add;
    }
    private int N = (int) 1e9;
    private Node root = new Node();
    public void update(Node node, int start, int end, int l, int r, int val) {
        if (l <= start && end <= r) {
            node.val += (end - start + 1) * val;
            node.add += val;
            return ;
        }
        int mid = (start + end) >> 1;
        pushDown(node, mid - start + 1, end - mid);
        if (l <= mid) update(node.left, start, mid, l, r, val);
        if (r > mid) update(node.right, mid + 1, end, l, r, val);
        pushUp(node);
    }
    public int query(Node node, int start, int end, int l, int r) {
        if (l <= start && end <= r) return node.val;
        int mid = (start + end) >> 1, ans = 0;
        pushDown(node, mid - start + 1, end - mid);
        if (l <= mid) ans += query(node.left, start, mid, l, r);
        if (r > mid) ans += query(node.right, mid + 1, end, l, r);
        return ans;
    }
    private void pushUp(Node node) {
        node.val = node.left.val + node.right.val;
    }
    private void pushDown(Node node, int leftNum, int rightNum) {
        if (node.left == null) node.left = new Node();
        if (node.right == null) node.right = new Node();
        if (node.add == 0) return ;
        node.left.val += node.add * leftNum;
        node.right.val += node.add * rightNum;
        // å¯¹åŒºé—´è¿›è¡Œã€ŒåŠ å‡ã€çš„æ›´æ–°æ“ä½œï¼Œä¸‹æ¨æ‡’æƒ°æ ‡è®°æ—¶éœ€è¦ç´¯åŠ èµ·æ¥ï¼Œä¸èƒ½ç›´æ¥è¦†ç›–
        node.left.add += node.add;
        node.right.add += node.add;
        node.add = 0;
    }
}
```

**å†æ¬¡å¼ºè°ƒä¸€éï¼šä¸Šé¢ç»™å‡ºçš„æ¨¡ç‰ˆåŸºäºæ±‚ã€ŒåŒºé—´å’Œã€ä»¥åŠå¯¹åŒºé—´è¿›è¡Œã€ŒåŠ å‡ã€çš„æ›´æ–°æ“ä½œï¼Œä¸”ä¸ºã€ŒåŠ¨æ€å¼€ç‚¹ã€**

ä½†æ˜¯ä¸‹é¢ç»™å‡ºçš„é¢˜ç›®å®æˆ˜ä¸­ï¼Œæœ‰äº›é¢˜ç›®éœ€è¦å¯¹æ¨¡ç‰ˆè¿›è¡Œå°å°çš„ä¿®æ”¹ (å¾ˆå¤šäººé—®è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œç»Ÿä¸€æ•´ç†æ±‡æ€»ä¸€ä¸‹ï¼ï¼)

- å¯¹äºè¡¨ç¤ºä¸ºã€Œ**åŒºé—´å’Œ**ã€ä¸”**å¯¹åŒºé—´è¿›è¡Œã€ŒåŠ å‡ã€çš„æ›´æ–°æ“ä½œ**çš„æƒ…å†µï¼Œæˆ‘ä»¬åœ¨æ›´æ–°èŠ‚ç‚¹å€¼çš„æ—¶å€™ã€éœ€è¦âœ–ï¸å·¦å³å­©å­åŒºé—´å¶å­èŠ‚ç‚¹çš„æ•°é‡ (æ³¨æ„æ˜¯å¶å­èŠ‚ç‚¹çš„æ•°é‡)ã€ï¼›æˆ‘ä»¬åœ¨ä¸‹æ¨æ‡’æƒ°æ ‡è®°çš„æ—¶å€™ã€éœ€è¦ç´¯åŠ ã€ï¼ï¼(è¿™ç§æƒ…å†µå’Œæ¨¡ç‰ˆä¸€è‡´ï¼ï¼) **å¦‚é¢˜ç›® [æœ€è¿‘çš„è¯·æ±‚æ¬¡æ•°](https://leetcode.cn/problems/number-of-recent-calls/)**
- å¯¹äºè¡¨ç¤ºä¸ºã€Œ**åŒºé—´å’Œ**ã€ä¸”**å¯¹åŒºé—´è¿›è¡Œã€Œè¦†ç›–ã€çš„æ›´æ–°æ“ä½œ**çš„æƒ…å†µï¼Œæˆ‘ä»¬åœ¨æ›´æ–°èŠ‚ç‚¹å€¼çš„æ—¶å€™ã€éœ€è¦âœ–ï¸å·¦å³å­©å­åŒºé—´å¶å­èŠ‚ç‚¹çš„æ•°é‡ (æ³¨æ„æ˜¯å¶å­èŠ‚ç‚¹çš„æ•°é‡)ã€ï¼›æˆ‘ä»¬åœ¨ä¸‹æ¨æ‡’æƒ°æ ‡è®°çš„æ—¶å€™ã€**ä¸**éœ€è¦ç´¯åŠ ã€ï¼ï¼(å› ä¸ºæ˜¯è¦†ç›–æ“ä½œï¼ï¼) **å¦‚é¢˜ç›® [åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„å¯ä¿®æ”¹](https://leetcode.cn/problems/range-sum-query-mutable/)**
- å¯¹äºè¡¨ç¤ºä¸ºã€Œ**åŒºé—´æœ€å€¼**ã€ä¸”**å¯¹åŒºé—´è¿›è¡Œã€ŒåŠ å‡ã€çš„æ›´æ–°æ“ä½œ**çš„æƒ…å†µï¼Œæˆ‘ä»¬åœ¨æ›´æ–°èŠ‚ç‚¹å€¼çš„æ—¶å€™ã€**ä¸**éœ€è¦âœ–ï¸å·¦å³å­©å­åŒºé—´å¶å­èŠ‚ç‚¹çš„æ•°é‡ (æ³¨æ„æ˜¯å¶å­èŠ‚ç‚¹çš„æ•°é‡)ã€ï¼›æˆ‘ä»¬åœ¨ä¸‹æ¨æ‡’æƒ°æ ‡è®°çš„æ—¶å€™ã€éœ€è¦ç´¯åŠ ã€ï¼ï¼ **å¦‚é¢˜ç›® [æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ I](https://leetcode.cn/problems/my-calendar-i/)ã€[æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ III](https://leetcode.cn/problems/my-calendar-iii/)**

**æ³¨æ„**ï¼šå¯¹äºé¢˜ç›® **[æœ€è¿‘çš„è¯·æ±‚æ¬¡æ•°](https://leetcode.cn/problems/number-of-recent-calls/)** å’Œ **[åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„å¯ä¿®æ”¹](https://leetcode.cn/problems/range-sum-query-mutable/)** å¯ä»¥ã€Œ**ä¸ç”¨**âœ–ï¸å·¦å³å­©å­åŒºé—´å¶å­èŠ‚ç‚¹çš„æ•°é‡ã€

ä¸ºä»€ä¹ˆï¼Ÿï¼Ÿå› ä¸ºè¿™ä¸¤ä¸ªé¢˜ç›®æ˜¯ã€Œç‚¹æ›´æ–°ã€ï¼Œåœ¨ä»‹ç»çº¿æ®µæ ‘æ›´æ–°çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¯´è¿‡ï¼šã€Œç‚¹æ›´æ–°ã€å’Œã€ŒåŒºé—´æ›´æ–°ã€å¯ä»¥åˆå¹¶æˆä¸€ç§ï¼Œã€Œç‚¹æ›´æ–°ã€ä¸å°±æ˜¯æ›´æ–°é•¿åº¦ä¸º 1 çš„åŒºé—´å˜›ï¼ï¼

ä¸Šé¢ä¸¤ä¸ªé¢˜ç›®è°ƒç”¨æ›´æ–°å‡½æ•°çš„æ–¹å¼ä¸ºï¼š`update(root, 1, N, t, t, 1);` å’Œ `update(root, 0, N, i, i, nums[i]);`

ç”±äºåŒºé—´æ˜¯ä¸€ä¸ªç‚¹ï¼Œæ‰€ä»¥ä¸€å®šä¼šæ›´æ–°åˆ°å¶å­èŠ‚ç‚¹ï¼Œæ•…å¯ä»¥ä¸ç”¨âœ–ï¸å·¦å³å­©å­åŒºé—´å¶å­èŠ‚ç‚¹çš„æ•°é‡ï¼ï¼

## é¢˜ç›®å®æˆ˜

### æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ I

**é¢˜ç›®è¯¦æƒ…å¯è§ [æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ I](https://leetcode.cn/problems/my-calendar-i/)**

è¯¥é¢˜ç›®åŸºäºä¸‹é¢ã€Œ**æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ III**ã€çš„æ€è·¯ï¼ï¼ï¼

```java
class MyCalendar {

    public MyCalendar() {

    }
    
    public boolean book(int start, int end) {
        // å…ˆæŸ¥è¯¢è¯¥åŒºé—´æ˜¯å¦ä¸º 0
        if (query(root, 0, N, start, end - 1) != 0) return false;
        // æ›´æ–°è¯¥åŒºé—´
        update(root, 0, N, start, end - 1, 1);
        return true;
    }
    // *************** ä¸‹é¢æ˜¯æ¨¡ç‰ˆ ***************
    class Node {
        // å·¦å³å­©å­èŠ‚ç‚¹
        Node left, right;
        // å½“å‰èŠ‚ç‚¹å€¼ï¼Œä»¥åŠæ‡’æƒ°æ ‡è®°çš„å€¼
        int val, add;
    }
    private int N = (int) 1e9;
    private Node root = new Node();
    public void update(Node node, int start, int end, int l, int r, int val) {
        if (l <= start && end <= r) {
            node.val += val;
            node.add += val;
            return ;
        }
        pushDown(node);
        int mid = (start + end) >> 1;
        if (l <= mid) update(node.left, start, mid, l, r, val);
        if (r > mid) update(node.right, mid + 1, end, l, r, val);
        pushUp(node);
    }
    public int query(Node node, int start, int end, int l, int r) {
        if (l <= start && end <= r) return node.val;
        pushDown(node);
        int mid = (start + end) >> 1, ans = 0;
        if (l <= mid) ans = query(node.left, start, mid, l, r);
        if (r > mid) ans = Math.max(ans, query(node.right, mid + 1, end, l, r));
        return ans;
    }
    private void pushUp(Node node) {
        // æ¯ä¸ªèŠ‚ç‚¹å­˜çš„æ˜¯å½“å‰åŒºé—´çš„æœ€å¤§å€¼
        node.val = Math.max(node.left.val, node.right.val);
    }
    private void pushDown(Node node) {
        if (node.left == null) node.left = new Node();
        if (node.right == null) node.right = new Node();
        if (node.add == 0) return ;
        node.left.val += node.add;
        node.right.val += node.add;
        node.left.add += node.add;
        node.right.add += node.add;
        node.add = 0;
    }
}
```

### æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ II

**é¢˜ç›®è¯¦æƒ…å¯è§ [æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ II](https://leetcode.cn/problems/my-calendar-ii/)**

è¯¥é¢˜ç›®åŸºäºä¸‹é¢ã€Œ**æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ III**ã€çš„æ€è·¯ï¼ï¼ï¼

```java
class MyCalendarTwo {

    public MyCalendarTwo() {

    }
    
    public boolean book(int start, int end) {
        if (query(root, 0, N, start, end - 1) == 2) return false;
        update(root, 0, N, start, end - 1, 1);
        return true;
    }
    // *************** ä¸‹é¢æ˜¯æ¨¡ç‰ˆ ***************
    class Node {
        // å·¦å³å­©å­èŠ‚ç‚¹
        Node left, right;
        // å½“å‰èŠ‚ç‚¹å€¼ï¼Œä»¥åŠæ‡’æƒ°æ ‡è®°çš„å€¼
        int val, add;
    }
    private int N = (int) 1e9;
    private Node root = new Node();
    public void update(Node node, int start, int end, int l, int r, int val) {
        if (l <= start && end <= r) {
            node.val += val;
            node.add += val;
            return ;
        }
        pushDown(node);
        int mid = (start + end) >> 1;
        if (l <= mid) update(node.left, start, mid, l, r, val);
        if (r > mid) update(node.right, mid + 1, end, l, r, val);
        pushUp(node);
    }
    public int query(Node node, int start, int end, int l, int r) {
        if (l <= start && end <= r) return node.val;
        pushDown(node);
        int mid = (start + end) >> 1, ans = 0;
        if (l <= mid) ans = query(node.left, start, mid, l, r);
        if (r > mid) ans = Math.max(ans, query(node.right, mid + 1, end, l, r));
        return ans;
    }
    private void pushUp(Node node) {
        // æ¯ä¸ªèŠ‚ç‚¹å­˜çš„æ˜¯å½“å‰åŒºé—´çš„æœ€å¤§å€¼
        node.val = Math.max(node.left.val, node.right.val);
    }
    private void pushDown(Node node) {
        if (node.left == null) node.left = new Node();
        if (node.right == null) node.right = new Node();
        if (node.add == 0) return ;
        node.left.val += node.add;
        node.right.val += node.add;
        node.left.add += node.add;
        node.right.add += node.add;
        node.add = 0;
    }
}
```

### æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ III

**é¢˜ç›®è¯¦æƒ…å¯è§ [æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ III](https://leetcode.cn/problems/my-calendar-iii/)**

ä¸Šé¢è¯´è¿‡ã€ŒèŠ‚ç‚¹çš„å€¼ä¸æ­¢å¯ä»¥è¡¨ç¤ºè¯¥åŒºé—´çš„å’Œã€ï¼Œè¿˜å¯ä»¥ã€Œè¡¨ç¤ºä¸ºå½“å‰åŒºé—´çš„æœ€å€¼ã€ï¼Œè¯¥é¢˜ç›®å­˜å‚¨çš„å°±æ˜¯åŒºé—´çš„æœ€å¤§å€¼

```java
class MyCalendarThree {

    public MyCalendarThree() {

    }
    
    public int book(int start, int end) {
        // åªç”¨åˆ°äº† update
        update(root, 0, N, start, end - 1, 1);
        // æœ€å¤§å€¼å³ä¸ºæ ¹èŠ‚ç‚¹çš„å€¼
        return root.val;
    }
    // *************** ä¸‹é¢æ˜¯æ¨¡ç‰ˆ ***************
    class Node {
        // å·¦å³å­©å­èŠ‚ç‚¹
        Node left, right;
        // å½“å‰èŠ‚ç‚¹å€¼ï¼Œä»¥åŠæ‡’æƒ°æ ‡è®°çš„å€¼
        int val, add;
    }
    private int N = (int) 1e9;
    private Node root = new Node();
    public void update(Node node, int start, int end, int l, int r, int val) {
        if (l <= start && end <= r) {
            node.val += val;
            node.add += val;
            return ;
        }
        pushDown(node);
        int mid = (start + end) >> 1;
        if (l <= mid) update(node.left, start, mid, l, r, val);
        if (r > mid) update(node.right, mid + 1, end, l, r, val);
        pushUp(node);
    }
    public int query(Node node, int start, int end, int l, int r) {
        if (l <= start && end <= r) return node.val;
        pushDown(node);
        int mid = (start + end) >> 1, ans = 0;
        if (l <= mid) ans = query(node.left, start, mid, l, r);
        if (r > mid) ans = Math.max(ans, query(node.right, mid + 1, end, l, r));
        return ans;
    }
    private void pushUp(Node node) {
        // æ¯ä¸ªèŠ‚ç‚¹å­˜çš„æ˜¯å½“å‰åŒºé—´çš„æœ€å¤§å€¼
        node.val = Math.max(node.left.val, node.right.val);
    }
    private void pushDown(Node node) {
        if (node.left == null) node.left = new Node();
        if (node.right == null) node.right = new Node();
        if (node.add == 0) return ;
        node.left.val += node.add;
        node.right.val += node.add;
        node.left.add += node.add;
        node.right.add += node.add;
        node.add = 0;
    }
}
```

### Range æ¨¡å—

**é¢˜ç›®è¯¦æƒ…å¯è§ [Range æ¨¡å—](https://leetcode.cn/problems/range-module/)**

æ¯ä¸ªèŠ‚ç‚¹çš„å€¼è¡¨ç¤ºå½“å‰åŒºé—´æ˜¯å¦è¢«è¦†ç›–

```java
class RangeModule {

    public RangeModule() {

    }
    
    public void addRange(int left, int right) {
        // 1 è¡¨ç¤ºè¦†ç›–ï¼›-1 è¡¨ç¤ºå–æ¶ˆè¦†ç›–
        update(root, 1, N, left, right - 1, 1);
    }
    
    public boolean queryRange(int left, int right) {
        return query(root, 1, N, left, right - 1);
    }
    
    public void removeRange(int left, int right) {
        // 1 è¡¨ç¤ºè¦†ç›–ï¼›-1 è¡¨ç¤ºå–æ¶ˆè¦†ç›–
        update(root, 1, N, left, right - 1, -1);
    }

    // *************** ä¸‹é¢æ˜¯æ¨¡ç‰ˆ ***************
    class Node {
        Node left, right;
        // è¡¨ç¤ºå½“å‰åŒºé—´æ˜¯å¦è¢«è¦†ç›–
        boolean cover;
        int add;
    }
    private int N = (int) 1e9;
    private Node root = new Node();
    public void update(Node node, int start, int end, int l, int r, int val) {
        if (l <= start && end <= r) {
            // 1 è¡¨ç¤ºè¦†ç›–ï¼›-1 è¡¨ç¤ºå–æ¶ˆè¦†ç›–
            node.cover = val == 1;
            node.add = val;
            return ;
        }
        int mid = (start + end) >> 1;
        pushDown(node, mid - start + 1, end - mid);
        if (l <= mid) update(node.left, start, mid, l, r, val);
        if (r > mid) update(node.right, mid + 1, end, l, r, val);
        pushUp(node);
    }
    public boolean query(Node node, int start, int end, int l, int r) {
        if (l <= start && end <= r) return node.cover;
        int mid = (start + end) >> 1;
        pushDown(node, mid - start + 1, end - mid);
        // æŸ¥è¯¢å·¦å³å­æ ‘æ˜¯å¦è¢«è¦†ç›–
        boolean ans = true;
        if (l <= mid) ans = ans && query(node.left, start, mid, l, r);
        if (r > mid) ans = ans && query(node.right, mid + 1, end, l, r);
        return ans;
    }
    private void pushUp(Node node) {
        // å‘ä¸Šæ›´æ–°
        node.cover = node.left.cover && node.right.cover;
    }
    private void pushDown(Node node, int leftNum, int rightNum) {
        if (node.left == null) node.left = new Node();
        if (node.right == null) node.right = new Node();
        if (node.add == 0) return ;
        node.left.cover = node.add == 1;
        node.right.cover = node.add == 1;
        node.left.add = node.add;
        node.right.add = node.add;
        node.add = 0;
    }
}
```

### åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„å¯ä¿®æ”¹

**é¢˜ç›®è¯¦æƒ…å¯è§ [åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„å¯ä¿®æ”¹](https://leetcode.cn/problems/range-sum-query-mutable/)**

æ–¹æ³•ä¸€ï¼š

```java
class NumArray {

    private final int n;
    private final int[] arr;
    private final int[] tree;
    private final int[] add;

    public NumArray(int[] nums) {
        this.n = nums.length;
        this.arr = nums;
        // å¿…é¡»å¼€ 4 å€é•¿åº¦çš„æ•°ç»„
        this.tree = new int[n << 2];
        this.add = new int[n << 2];
        buildTree(0, n - 1, 1);
    }
    
    public void update(int index, int val) {
        update(0, n - 1, 1, index, val);
    }
    
    public int sumRange(int left, int right) {
        return query(0, n - 1, left, right, 1);
    }

    public void updateRange(int l, int r, int val) {
        update(0, n - 1, 1, l, r, val);
    }

    private void buildTree(int start, int end, int rootId) {
        if (start == end) {
            tree[rootId] = arr[start];
            return ;
        }
        int mid = (start + end) >> 1;
        buildTree(start, mid, rootId << 1);
        buildTree(mid + 1, end, rootId << 1 | 1);
        pushUp(rootId);
    }
    private void update(int start, int end, int rootId, int updateIndex, int val) {
        if (start == end) {
            arr[start] = tree[rootId] = val;
            return ;
        }
        int mid = (start + end) >> 1;
        if (updateIndex > mid) {
            update(mid + 1, end, rootId << 1 | 1, updateIndex, val);
        } else {
            update(start, mid, rootId << 1, updateIndex, val);
        }
        pushUp(rootId);
    }
    private void update(int start, int end, int rootId, int l, int r, int val) {
        // æ— äº¤é›†
        if (r < start || l > end) return ;
        // å¦‚æœæœ¬åŒºé—´å®Œå…¨åœ¨æ“ä½œåŒºé—´ [l, r] ä»¥å†…
        else if (l <= start && end <= r) {
            // æ›´æ–°æ•°å­—å’Œï¼Œå‘ä¸Šä¿æŒæ­£ç¡®
            tree[rootId] += val * (end - start + 1);
            // å¢åŠ  add æ ‡è®°ï¼Œè¡¨ç¤ºæœ¬åŒºé—´çš„ Sum æ­£ç¡®ï¼Œå­åŒºé—´çš„ Sum ä»éœ€è¦æ ¹æ® add çš„å€¼æ¥è°ƒæ•´
            add[rootId] += val;
            return ;
        }
        int mid = (start + end) >> 1;
        // ä¸‹æ¨æ ‡è®°
        pushDown(rootId, mid - start + 1, end - mid);
        update(start, mid, rootId << 1, l, r, val);
        update(mid + 1, end, rootId << 1 | 1, l, r, val);
        pushUp(rootId);
    }
    private int query(int start, int end, int l, int r, int rootId) {
        if (r < start || l > end) return 0;
        else if (l <= start && end <= r) return tree[rootId];
        int mid = (start + end) >> 1;
        // ä¸‹æ¨æ ‡è®°
        pushDown(rootId, mid - start + 1, end - mid);
        int lSum = query(start, mid, l, r, rootId << 1);
        int rSum = query(mid + 1, end, l, r, rootId << 1 | 1);
        return lSum + rSum;
    }

    private void pushUp(int rootId) {
        tree[rootId] = tree[rootId << 1] + tree[rootId << 1 | 1];
    }
    private void pushDown(int rootId, int leftNum, int rightNum) {
        if (add[rootId] == 0) return ;
        // ä¸‹æ¨æ ‡è®°
        add[rootId << 1] += add[rootId];
        add[rootId << 1 | 1] += add[rootId];
        // ä¿®æ”¹å­èŠ‚ç‚¹çš„ Sum ä½¿ä¹‹ä¸å¯¹åº”çš„ add ç›¸å¯¹åº”
        tree[rootId << 1] += leftNum * add[rootId];
        tree[rootId << 1 | 1] += rightNum * add[rootId];
        add[rootId] = 0;
    }
}
```

æ–¹æ³•äºŒï¼šåŸºäºåŠ¨æ€å¼€ç‚¹ï¼Œå®Œå…¨æ˜¯ä¸ºäº†åŠ æ·±å¯¹åŠ¨æ€å¼€ç‚¹çš„ç†è§£

```java
class NumArray {

    public NumArray(int[] nums) {
        N = nums.length - 1;
        for (int i = 0; i <= N; i++) {
            update(root, 0, N, i, i, nums[i]);
        }
    }
    
    public void update(int index, int val) {
        update(root, 0, N, index, index, val);
    }
    
    public int sumRange(int left, int right) {
        return query(root, 0, N, left, right);
    }

    class Node {
        // å·¦å³å­©å­èŠ‚ç‚¹
        Node left, right;
        // å½“å‰èŠ‚ç‚¹å€¼ï¼Œä»¥åŠæ‡’æƒ°æ ‡è®°çš„å€¼
        int val, add;
    }
    private int N;
    private Node root = new Node();
    public void update(Node node, int start, int end, int l, int r, int val) {
        if (l <= start && end <= r) {
            node.val = (end - start + 1) * val;
            node.add = val;
            return ;
        }
        int mid = (start + end) >> 1;
        pushDown(node, mid - start + 1, end - mid);
        if (l <= mid) update(node.left, start, mid, l, r, val);
        if (r > mid) update(node.right, mid + 1, end, l, r, val);
        pushUp(node);
    }
    public int query(Node node, int start, int end, int l, int r) {
        if (l <= start && end <= r) return node.val;
        int mid = (start + end) >> 1, ans = 0;
        pushDown(node, mid - start + 1, end - mid);
        if (l <= mid) ans += query(node.left, start, mid, l, r);
        if (r > mid) ans += query(node.right, mid + 1, end, l, r);
        return ans;
    }
    private void pushUp(Node node) {
        node.val = node.left.val + node.right.val;
    }
    private void pushDown(Node node, int leftNum, int rightNum) {
        if (node.left == null) node.left = new Node();
        if (node.right == null) node.right = new Node();
        if (node.add == 0) return ;
        node.left.val = node.add * leftNum;
        node.right.val = node.add * rightNum;
        node.left.add = node.add;
        node.right.add = node.add;
        node.add = 0;
    }
}
```

### æœ€è¿‘çš„è¯·æ±‚æ¬¡æ•°

**é¢˜ç›®è¯¦æƒ…å¯è§ [æœ€è¿‘çš„è¯·æ±‚æ¬¡æ•°](https://leetcode.cn/problems/number-of-recent-calls/)**

æ–¹æ³•ä¸€ï¼šçº¿æ®µæ ‘ (åŠ¨æ€å¼€ç‚¹)ï¼›å®Œå…¨æ˜¯ä¸ºäº†åŠ æ·±å¯¹çº¿æ®µæ ‘çš„ç†è§£

```java
class RecentCounter {

    public RecentCounter() {

    }
    
    public int ping(int t) {
        update(root, 1, N, t, t, 1);
        return query(root, 1, N, Math.max(0, t - 3000), t);
    }

    // *************** ä¸‹é¢æ˜¯æ¨¡ç‰ˆ ***************
    class Node {
        // å·¦å³å­©å­èŠ‚ç‚¹
        Node left, right;
        // å½“å‰èŠ‚ç‚¹å€¼ï¼Œä»¥åŠæ‡’æƒ°æ ‡è®°çš„å€¼
        int val, add;
    }
    private int N = (int) 1e9;
    private Node root = new Node();
    public void update(Node node, int start, int end, int l, int r, int val) {
        if (l <= start && end <= r) {
            node.val += val;
            node.add += val;
            return ;
        }
        int mid = (start + end) >> 1;
        pushDown(node, mid - start + 1, end - mid);
        if (l <= mid) update(node.left, start, mid, l, r, val);
        if (r > mid) update(node.right, mid + 1, end, l, r, val);
        pushUp(node);
    }
    public int query(Node node, int start, int end, int l, int r) {
        if (l <= start && end <= r) return node.val;
        int mid = (start + end) >> 1, ans = 0;
        pushDown(node, mid - start + 1, end - mid);
        if (l <= mid) ans = query(node.left, start, mid, l, r);
        if (r > mid) ans += query(node.right, mid + 1, end, l, r);
        return ans;
    }
    private void pushUp(Node node) {
        node.val = node.left.val + node.right.val;
    }
    private void pushDown(Node node, int leftNum, int rightNum) {
        if (node.left == null) node.left = new Node();
        if (node.right == null) node.right = new Node();
        if (node.add == 0) return ;
        node.left.val += node.add * leftNum;
        node.right.val += node.add * rightNum;
        // å¯¹åŒºé—´è¿›è¡Œã€ŒåŠ å‡ã€çš„æ›´æ–°æ“ä½œï¼Œä¸‹æ¨æ‡’æƒ°æ ‡è®°æ—¶éœ€è¦ç´¯åŠ èµ·æ¥ï¼Œä¸èƒ½ç›´æ¥è¦†ç›–
        node.left.add += node.add;
        node.right.add += node.add;
        node.add = 0;
    }
}
```

æ–¹æ³•äºŒï¼šé˜Ÿåˆ—

```java
class RecentCounter {

    private Deque<Integer> deque;

    public RecentCounter() {
        deque = new ArrayDeque<>();
    }
    
    public int ping(int t) {
        int past = t - 3000;
        deque.addLast(t);
        while (deque.getFirst() < past) deque.removeFirst();
        return deque.size();
    }
}
```

### æ‰è½çš„æ–¹å—

**é¢˜ç›®è¯¦æƒ…å¯è§ [æ‰è½çš„æ–¹å—](https://leetcode.cn/problems/falling-squares/)**

ä¸Šé¢è¯´è¿‡ã€ŒèŠ‚ç‚¹çš„å€¼ä¸æ­¢å¯ä»¥è¡¨ç¤ºè¯¥åŒºé—´çš„å’Œã€ï¼Œè¿˜å¯ä»¥ã€Œè¡¨ç¤ºä¸ºå½“å‰åŒºé—´çš„æœ€å€¼ã€ï¼Œè¯¥é¢˜ç›®å­˜å‚¨çš„å°±æ˜¯åŒºé—´çš„æœ€å¤§å€¼

```java
class Solution {
    public List<Integer> fallingSquares(int[][] positions) {
        List<Integer> ans = new ArrayList<>();
        for (int[] position : positions) {
            int x = position[0], h = position[1];
            // å…ˆæŸ¥è¯¢å‡º [x, x + h] çš„å€¼
            int cur = query(root, 0, N, x, x + h - 1);
            // æ›´æ–° [x, x + h - 1] ä¸º cur + h (ç›´æ¥è¦†ç›–)
            update(root, 0, N, x, x + h - 1, cur + h);
            ans.add(root.val);
        }
        return ans;
    }
    // *************** ä¸‹é¢æ˜¯æ¨¡ç‰ˆ ***************
    class Node {
        // å·¦å³å­©å­èŠ‚ç‚¹
        Node left, right;
        // å½“å‰èŠ‚ç‚¹å€¼ï¼Œä»¥åŠæ‡’æƒ°æ ‡è®°çš„å€¼
        int val, add;
    }
    private int N = (int) 1e9;
    private Node root = new Node();
    public void update(Node node, int start, int end, int l, int r, int val) {
        if (l <= start && end <= r) {
            node.val = val;
            node.add = val;
            return ;
        }
        pushDown(node);
        int mid = (start + end) >> 1;
        if (l <= mid) update(node.left, start, mid, l, r, val);
        if (r > mid) update(node.right, mid + 1, end, l, r, val);
        pushUp(node);
    }
    public int query(Node node, int start, int end, int l, int r) {
        if (l <= start && end <= r) return node.val;
        pushDown(node);
        int mid = (start + end) >> 1, ans = 0;
        if (l <= mid) ans = query(node.left, start, mid, l, r);
        if (r > mid) ans = Math.max(ans, query(node.right, mid + 1, end, l, r));
        return ans;
    }
    private void pushUp(Node node) {
        // æ¯ä¸ªèŠ‚ç‚¹å­˜çš„æ˜¯å½“å‰åŒºé—´çš„æœ€å¤§å€¼
        node.val = Math.max(node.left.val, node.right.val);
    }
    private void pushDown(Node node) {
        if (node.left == null) node.left = new Node();
        if (node.right == null) node.right = new Node();
        if (node.add == 0) return ;
        node.left.val = node.add;
        node.right.val = node.add;
        node.left.add = node.add;
        node.right.add = node.add;
        node.add = 0;
    }
}
```

### æœ€é•¿é€’å¢å­åºåˆ— II

**é¢˜ç›®è¯¦æƒ…å¯è§ [æœ€é•¿é€’å¢å­åºåˆ— II](https://leetcode.cn/problems/longest-increasing-subsequence-ii/)**

è¿™é‡Œæ˜¯ã€Œ**åŒºé—´æœ€å€¼**ã€ä¸”**å¯¹åŒºé—´è¿›è¡Œã€Œè¦†ç›–ã€çš„æ›´æ–°æ“ä½œ**ç±»å‹

ä¸‹é¢ç»™å‡ºä»£ç ï¼š

```java
class Solution {
    public int lengthOfLIS(int[] nums, int k) {
        int ans = 0;
        Map<Integer, Integer> map = new HashMap<>();
        for (int i = 0; i < nums.length; i++) {
            // æŸ¥è¯¢åŒºé—´ [nums[i] - k, nums[i] - 1] çš„æœ€å€¼
            int cnt = query(root, 0, N, Math.max(0, nums[i] - k), nums[i] - 1) + 1;
            // æ›´æ–°ï¼Œæ³¨æ„è¿™é‡Œæ˜¯è¦†ç›–æ›´æ–°ï¼Œå¯¹åº”çš„æ¨¡ç‰ˆä¸­è¦†ç›–æ›´æ–°ä¸éœ€è¦ç´¯åŠ ï¼Œå·²åœ¨ä¸‹æ–¹ä»£ç ä¸­æ ‡æ³¨
            update(root, 0, N, nums[i], nums[i], cnt);
            ans = Math.max(ans, cnt);
        }
        return ans;
    }
    // *************** ä¸‹é¢æ˜¯æ¨¡ç‰ˆ ***************
    class Node {
        Node left, right;
        int val, add;
    }
    private int N = (int) 1e5;
    private Node root = new Node();
    public void update(Node node, int start, int end, int l, int r, int val) {
        if (l <= start && end <= r) {
            node.val = val; // ä¸éœ€è¦ç´¯åŠ 
            node.add = val; // ä¸éœ€è¦ç´¯åŠ 
            return ;
        }
        pushDown(node);
        int mid = (start + end) >> 1;
        if (l <= mid) update(node.left, start, mid, l, r, val);
        if (r > mid) update(node.right, mid + 1, end, l, r, val);
        pushUp(node);
```