[toc]



### **第8章 一致空间（Coherence Spaces）**

#### **引言**

在早期的指称语义学（Denotational Semantics）中，[Scott (1969)] 提出了对无类型λ演算的研究，并且自那以后关于这个主题的研究成果层出不穷。他的方法的特点是**连续性**，即保持有向极限（directed joins）。在本章中，我们将介绍一种新的领域理论（Domain Theory），其中我们也有（并保持）上界的交（pullbacks）。这种性质称为**稳定性（stability）**，最初由 [Berry] 引入，试图给出**顺序算法（sequential algorithms）**的语义特征。

我们将发现，这种语义学非常适合于 **System F**，并引导我们走向**线性逻辑（Linear Logic）**。

---

### **8.1 一般思想**

指称语义学的基本思想是用**等价（equality）**（一种静态概念）来解释**归约（reduction）**（一种动态概念）。换句话说，我们对计算的**不变量（invariants）**建模。

然而，模型有很多种：自从 [G\"odel (1930)] 以来，人们就知道如何构造作为最大一致扩展（maximally consistent extensions）的模型。但这并不是我们想要的，因为它并没有提供任何信息。

我们想要的是**字面地**理解一种简单的解释——类型 $U \to V$ 的对象是从 $U$ 到 $V$ 的函数，并看看我们能否给“函数”一词赋予合理的含义。通过这种方式，我们试图避免被**完备性（completeness）**所困扰，而是寻找简单的几何想法。

**第一种想法**是：

- **类型 = 集合**
- $U \to V$ 是从 $U$ 到 $V$ 的所有函数的集合（在集合论的意义上）

这种解释很好，但它并没有解释任何东西。计算上有趣的对象只是淹没在集合论函数的海洋中。函数空间也很快变得巨大。

**Kreisel** 提出了以下想法（遗传有效操作，hereditarily effective operations）：

- **类型 = 自然数上的部分等价关系（partial equivalence relation on $\mathbb{N}$）**
- $U \to V$ 是所有部分递归函数 $f$ 的集合，使得如果 $x \sim_U y$，则 $f(x) \sim_V f(y)$，并且定义一个等价关系：
  $$
  f \sim_{U \to V} g \quad \text{当且仅当} \quad \forall x, y \ (x \sim_U y \implies f(x) \sim_V g(y))
  $$

这种方法更接近我们试图建模的计算范式——但似乎过于贴近了，因为实际上它几乎只是在对语法本身进行解释，外加一些无趣的编码。

**Scott** 的想法要好得多：

- **类型 = 拓扑空间**
- $U \to V$ 是从 $U$ 到 $V$ 的**连续函数**的集合

然而，众所周知，拓扑学并不适合构造函数空间。什么时候我们应该说函数序列收敛——逐点收敛，还是以某种方式一致收敛？

为了解决这些问题，Scott 被迫对他的拓扑空间施加了与传统几何精神相去甚远的严格限制。实际上，他的空间实际上只是具有有向极限的偏序集；拓扑只是一个附带特征。因此，自然地，我们会问自己，拓扑直觉本身是否就是错误的，并寻找其他方法。

---

### **8.2 一致空间（Coherence Spaces）**

**一致空间**是满足以下条件的集合 $A$（由集合组成的集合）：

1. **向下封闭性（Down-closure）**：如果 $a \in A$ 且 $a' \subset a$，则 $a' \in A$。

2. **二元完备性（Binary completeness）**：如果 $M \subset A$ 且对所有 $a_1, a_2 \in M$，有 $a_1 \cup a_2 \in A$，则 $\bigcup M \in A$。

特别地，我们有空集 $\emptyset \in A$。

**示例**：

- 可以将一致空间视为一个偏序集（按包含关系排序）；作为这样的偏序集，它是**代数的（algebraic）**，并满足二元条件 (ii)，因此：

  - 对于 **Bool**（布尔值），一致空间是：
    $$
    \emptyset \\
    \{ t \} \quad \{ f \}
    $$
    - 其中 $\{ t \}$ 和 $\{ f \}$ 是元素。

  - 对于 **Int**（整数），一致空间是：
    $$
    \emptyset \\
    \{ 0 \} \quad \{ 1 \} \quad \{ 2 \} \quad \dots
    $$
    - 其中每个单元素集合 $\{ n \}$ 表示一个整数。

- 然而，下图所示的空间并不是一致空间：

  - 因为它不满足一致空间的定义条件。

#### **一致空间的网络（Web）**

- 定义 $|A| = \bigcup A = \{ \alpha : \{ \alpha \} \in A \}$。$|A|$ 的元素称为**标记（tokens）**。

- 定义一致关系（coherence relation）为：对于 $\alpha, \alpha' \in |A|$，
  $$
  \alpha \ \# \ \alpha' \quad \text{当且仅当} \quad \{ \alpha, \alpha' \} \in A
  $$
  - 这是一个**自反对称关系（reflexive symmetric relation）**，因此 $|A|$ 配备了 $\#$ 成为一个**图（graph）**，称为 $A$ 的**网络（web）**。

- 例如，**Bool** 的网络由标记 $t$ 和 $f$ 组成，它们是不一致的（互相不连通）；类似地，**Int** 的网络是一个离散图，其顶点是整数。

- 这样的域称为**平坦的（flat）**。

从一致空间的网络，我们可以恢复一致空间：

- $$
  a \in A \quad \text{当且仅当} \quad a \subset |A| \ \text{且} \ \forall \alpha_1, \alpha_2 \in a, \ \alpha_1 \ \# \ \alpha_2
  $$

- 换句话说，一个点（point）就是一个**团（clique）**，即一个完全子图。

#### **解释**

我们的目标是用一致空间 $A$ 来解释一个类型，并用 $A$ 的一个点来解释该类型的一个项。这里的点是 $A$ 的**一致子集**（一般是无限的）；我们用 $A_{\text{fin}}$ 表示有限点的集合。

为了有效地处理 $A$ 的点，我们需要引入**有限近似（finite approximation）**的概念。

- 一个 $a \in A$ 的**近似**是它的任何子集 $a'$。

- 一致空间的条件 (i) 确保了近似仍然在 $A$ 中。

- 最重要的是，$a$ 有足够多的有限近似：

  - $a$ 是其有限近似的并。

  - 这些有限近似的集合是**有向的（directed）**，即：

    1. **非空**：$\emptyset \in I$。

    2. **向上封闭**：如果 $a', a'' \in I$，则存在 $a \in I$，使得 $a', a'' \subset a$（取 $a = a' \cup a''$）。

这种想法源于以下概念：

- 一方面，我们有 $A$ 的**真实（total）**对象。例如，在 **Bool** 中，单元素集合 $\{ t \}$ 和 $\{ f \}$；在 **Int** 中，$\{ 0 \}, \{ 1 \}, \{ 2 \}$ 等。

- 另一方面，我们有**近似（approximants）**，在这两个简单的例子中，$\emptyset$ 是唯一的例子。它们是**部分对象（partial objects）**。

添加部分对象与递归理论中的意义类似，我们从全函数转向部分函数：例如，对于整数（由单元素集合表示），我们添加“未定义”的 $\emptyset$。

然而，不应对这种直觉过分执着。例如，试图在任意一致空间 $A$ 中识别全点（total points）并不是明智的。

- 我们可能会认为 $A$ 的全点是极大点，即满足：
  $$
  \forall \alpha \in |A| \left( \forall \alpha' \in a, \ \alpha \ \# \ \alpha' \implies \alpha \in a \right)
  $$
  - 这在简单情况下（整数、布尔值等）确实成立。

- 然而，我们希望在作为复杂类型解释的一致空间中定义全性（totality），使用类似于可归约性（reducibility）的公式（参见第6.1节）。

- 这些公式具有越来越大的逻辑复杂性，完全不可预测，而极大性仍然是 $\Pi_2^0$ 的，因此我们不能希望它们重合。

- 实际上，对于任何给定的一致空间，都有许多全性的概念，就像对于同一类型有许多可归约性候选者一样（第14章）。实际上，语义学将一切都部分化（partialises），全对象在其中有点迷失了。

---

### **8.3 稳定函数（Stable Functions）**

给定两个一致空间 $A$ 和 $B$，从 $A$ 到 $B$ 的函数 $F$ 是**稳定的**，如果它满足以下条件：

1. **单调性（Monotonicity）**：

   - 如果 $a' \subset a \in A$，则 $F(a') \subset F(a)$。

   - 这意味着 $F$ 保持近似：如果我们在开始时提供更多的信息（$a$ 而不是 $a'$），那么我们最终会得到更多。

   - 或者说，$F$ 只使用其参数的**正面信息（positive information）**。

2. **连续性（Continuity）**：

   - 对于有向集合 $\{ a_i \}$，有 $F\left( \bigcup_{i \in I} a_i \right) = \bigcup_{i \in I} F(a_i)$。

   - 特别地，对于有限近似，$F(a) = \bigcup \{ F(a^\circ) : a^\circ \subset a, \ a^\circ \ \text{有限} \}$。

3. **稳定性（Stability）**：

   - 如果 $a_1 \cup a_2 \in A$，则 $F(a_1 \cap a_2) = F(a_1) \cap F(a_2)$。

   - 这意味着 $F$ 保持某种**上界的交**。

**解释**：

- **第一条件**表示 $F$ 是**单调的**，它只增加信息。

- **第二条件**表示 $F$ 是**连续的**，即 $F$ 可以由有限近似来完全确定。

- **第三条件**是**稳定性条件**，没有明显的拓扑意义，但在范畴论中，它表示拉回（pullbacks）必须被保持。

- 我们可以将一致空间视为一个范畴，其中从 $a'$ 到 $a$ 的态射是包含关系 $a' \subset a$。

- 稳定函数的第一个条件表示它是一个函子（functor），第二个条件表示它保持滤过极限（filtered colimits）。

- 第三个条件在范畴论中表示**拉回必须被保持**。

**示例**：

- 为了说明 $a_1$ 和 $a_2$ 的一致性假设不能被去除，我们考虑从 **Int** 到 **Int** 的所有稳定函数。

- 我们希望能够表示所有从自然数到自然数的函数，特别是定义如下的函数：

  $$
  f(0) = f(1) = 0, \quad f(n + 2) = 1
  $$

- 这迫使 $F(\{0\}) = \{0\}$，$F(\{1\}) = \{0\}$，$F(\{n+2\}) = \{1\}$，并且由于单调性，$F(\emptyset) = \emptyset$。

- 现在，$F(\{0\} \cap \{1\}) = F(\emptyset) = \emptyset \neq F(\{0\}) \cap F(\{1\})$；我们被 $0$ 和 $1$ 的不一致性所拯救，这使得 $\{0\} \cup \{1\} \notin \text{Int}$。

- 因此，稳定性条件强制在某些情况下存在**最小近似**，只需取被有上界的集合的交即可。

---

#### **8.3.1 平坦空间上的稳定函数**

让我们看看从 **Int** 到 **Int** 的稳定函数 $F$：

- 如果 $F(\emptyset) = \{ n \}$，那么对于所有 $a \in \text{Int}$，都有 $F(a) = \{ n \}$。

- 否则，$F(\emptyset) = \emptyset$。我们考虑部分函数 $f$，其定义域是满足 $F(\{ n \}) \neq \emptyset$ 的整数 $n$，并定义 $F(\{ n \}) = \{ f(n) \}$。

- 因此，我们得到：

  - **常量函数“天生”（by vocation）**：$\dot{n}$，其中 $\dot{n}(a) = \{ n \}$。

  - **部分函数** $f^\wedge$，其中 $F = f^\wedge$。

#### **8.3.2 并行或（Parallel Or）**

我们寻找从 $\text{Bool}, \text{Bool}$ 到 $\text{Bool}$ 的所有稳定函数 $F$，它们以这样的方式表示析取，即对于所有 $t$ 和 $f$ 的替换，有 $F(\{ \alpha \}, \{ \beta \}) = \{ \alpha \lor \beta \}$。

- 必须有 $F(a', b') \subset F(a, b)$，当 $a' \subset a$ 且 $b' \subset b$。

- 特别地，如果 $F(\emptyset, \emptyset) = \{ t \}$（或 $\{ f \}$），那么 $F$ 恒等于 $t$（或 $f$），这是不可能的。

- 类似地，有 $F(\{ f \}, \emptyset) = F(\emptyset, \{ f \}) = \emptyset$，因为 $F(\{ f \}, \emptyset) \subset F(\{ f \}, \{ t \}) = \{ t \}$，并且 $F(\{ f \}, \emptyset) \subset F(\{ f \}, \{ f \}) = \{ f \}$。

- 可以有 $F(\{ t \}, \emptyset) = \{ t \}$，但这将导致 $F(\emptyset, \{ t \}) = \emptyset$。

通过对稳定性条件的分析，我们发现存在以下函数：

- **$F_1$**：
  - $F_1(\{ t \}, \emptyset) = F_1(\{ t \}, \{ t \}) = F_1(\{ t \}, \{ f \}) = F_1(\{ f \}, \{ t \}) = \{ t \}$
  - $F_1(\{ f \}, \{ f \}) = \{ f \}$
  - 其他情况下，$F_1$ 的值为 $\emptyset$。

- **$F_2$**：通过交换参数，$F_2(a, b) = F_1(b, a)$。

- **$F_3$**：
  - $F_3(\{ t \}, \{ t \}) = F_3(\{ f \}, \{ t \}) = F_3(\{ t \}, \{ f \}) = \{ t \}$
  - $F_3(\{ f \}, \{ f \}) = \{ f \}$
  - 其他情况下，$F_3$ 的值为 $\emptyset$。

因此，我们得到了几个可能的稳定函数。

---

### **8.4 两个一致空间的直积**

一个从 $A, B$ 到 $C$ 的两个变量的函数 $F$ 是稳定的，当且仅当：

1. **单调性**：

   - 如果 $a' \subset a \in A$ 且 $b' \subset b \in B$，则 $F(a', b') \subset F(a, b)$。

2. **连续性**：

   - 对于有向集合 $\{ a_i \}$ 和 $\{ b_j \}$，有 $F\left( \bigcup_{i} a_i, \bigcup_{j} b_j \right) = \bigcup_{(i, j)} F(a_i, b_j)$。

3. **稳定性**：

   - 如果 $a_1 \cup a_2 \in A$ 且 $b_1 \cup b_2 \in B$，则 $F(a_1 \cap a_2, b_1 \cap b_2) = F(a_1, b_1) \cap F(a_2, b_2)$。

我们希望避免研究两个（或更多）变量的稳定函数，并将它们归约为一元的情况。为此，我们引入两个一致空间的**直积（direct product）** $A \otimes B$。

- 定义：

  - $|A \otimes B| = |A| + |B| = \{ 1 \} \times |A| \cup \{ 2 \} \times |B|$

- 一致关系：

  - $(1, \alpha) \ \# \ (1, \alpha')$ 当且仅当 $\alpha \ \# \ \alpha'$ 在 $A$ 中

  - $(2, \beta) \ \# \ (2, \beta')$ 当且仅当 $\beta \ \# \ \beta'$ 在 $B$ 中

  - $(1, \alpha) \ \# \ (2, \beta)$ 对于所有 $\alpha \in |A|$ 和 $\beta \in |B|$

- $A \otimes B$ 的点可以唯一地写为 $\{ 1 \} \times a \cup \{ 2 \} \times b$，其中 $a \in A$，$b \in B$。

- 读者可以验证，这在范畴论的意义上是一个积。

给定一个从 $A, B$ 到 $C$ 的稳定函数 $F$，我们可以定义一个从 $A \otimes B$ 到 $C$ 的函数 $G$：

- $G(\{ 1 \} \times a \cup \{ 2 \} \times b) = F(a, b)$

- 可以证明 $G$ 是稳定的。

---

### **8.5 函数空间（Function Space）**

我们开始的想法是“类型 = 一致空间”。上一节定义了对应于类型积的两个一致空间的积，但是对于箭头类型 $A \to B$，我们该怎么处理？

我们希望定义 $A \to B$ 为从 $A$ 到 $B$ 的稳定函数的集合，但这并没有表示为一致空间。

因此，我们将给出稳定函数集的一个特殊表示，使其成为一致空间。

#### **8.5.1 稳定函数的轨迹（Trace）**

**引理**：设 $F$ 是从 $A$ 到 $B$ 的稳定函数，$a \in A$，$\beta \in F(a)$，则：

1. 存在有限的 $a^\circ \subset a$，使得 $\beta \in F(a^\circ)$。

2. 如果 $a^\circ$ 在包含关系下在满足 (1) 的解中是最小的，那么 $a^\circ$ 是**最小的（least）**，并且是唯一的。

**证明**：

1. 由于 $a$ 是有限近似的有向并，$F(a) = \bigcup_{i} F(a_i)$，因此 $\beta \in F(a_i)$ 对某个 $i$ 成立。

2. 假设 $a^\circ$ 是最小的，若存在 $a' \subset a^\circ$，使得 $\beta \in F(a')$，那么根据稳定性条件，可以推导出 $a' = a^\circ$。

**解释**：

- 这表明，我们可以将稳定函数的行为完全由其在有限近似上的值来确定。

- **轨迹（Trace）** $Tr(F)$ 定义为满足以下条件的 $(a^\circ, \beta)$ 的集合：

  1. $a^\circ$ 是 $A$ 的有限点，$\beta \in |B|$。

  2. $\beta \in F(a^\circ)$。

  3. 如果 $a' \subset a^\circ$ 且 $\beta \in F(a')$，则 $a' = a^\circ$。

**重要性质**：

- $Tr(F)$ 唯一地确定了 $F$。

- **应用公式（App）**：

  $$
  F(a) = \{ \beta : \exists a^\circ \subset a, \ (a^\circ, \beta) \in Tr(F) \}
  $$

#### **8.5.2 函数空间的表示**

**命题**：当 $F$ 变化时，从 $A$ 到 $B$ 的稳定函数的轨迹形成了一个一致空间，记为 $A \to B$。

**证明**：

- 定义一致空间 $C$：

  - $|C| = A_{\text{fin}} \times |B|$，其中 $A_{\text{fin}}$ 是 $A$ 的有限点的集合。

  - 一致关系定义为：对于 $(a_1, \beta_1)$ 和 $(a_2, \beta_2)$，

    1. 如果 $a_1 \cup a_2 \in A$，则 $\beta_1 \ \# \ \beta_2$ 在 $B$ 中。

    2. 如果 $a_1 \cup a_2 \in A$ 且 $a_1 \neq a_2$，则 $\beta_1 \neq \beta_2$。

- 通过上述一致关系，可以证明从稳定函数 $F$ 的轨迹 $Tr(F)$ 得到的一致子集是 $C$ 的点。

- 反之，给定 $C$ 的一个点 $f$，可以定义一个从 $A$ 到 $B$ 的函数 $F$，其满足稳定性的条件。

---

#### **8.5.3 Berry序（Berry Order）**

作为一致空间，$A \to B$ 自然地按包含关系排序。稳定函数与其轨迹之间的双射诱导了一个序关系：

- 对于稳定函数 $F$ 和 $G$，定义 $F \leq_B G$ 当且仅当 $Tr(F) \subset Tr(G)$。

- 这被称为 **Berry 序**。

- **性质**：

  - $F \leq_B G$ 当且仅当对于所有 $a' \subset a \in A$，有 $F(a') = F(a) \cap G(a')$。

- 这表示评估保持了拉回（pullback），即在 $(A \to B) \otimes A$ 中，对于 $a' \subset a$，有一个拉回被保持。

---

#### **8.5.4 部分函数（Partial Functions）**

让我们看看这个构造如何作用于 $Int \to Int$。

- $Int_{\text{fin}} \simeq \mathbb{N} \cup \{ \emptyset \}$，$|Int| = \mathbb{N}$。

- 因此，$|Int \to Int| \simeq (\mathbb{N} \cup \{ \emptyset \}) \times \mathbb{N}$。

- 一致关系：

  - $(n, m) \ \# \ (n', m')$ 当且仅当 $n = n'$ 时有 $m = m'$。

- 这表示部分函数的图（graph），即自然数到自然数的部分函数的集合。

- Berry 序对应于包含关系，它是部分函数上的通常的扩展序。

---

### **总结**

本章介绍了一致空间的概念，并将其应用于指称语义学。我们通过一致空间来解释类型，并用稳定函数来解释函数类型。

- **一致空间**提供了一种新的框架，避免了传统拓扑学在构造函数空间时的问题。

- **稳定函数**满足单调性、连续性和稳定性条件，允许我们对函数行为进行精确的描述。

- **轨迹（Trace）**的概念使得我们能够将稳定函数表示为一致空间的点，从而定义函数空间。

- **Berry 序**为函数空间提供了一个自然的序结构，反映了函数之间的信息包含关系。

通过这些工具，我们可以构建一个适用于 **System F** 的语义模型，为理解和研究复杂类型系统提供了坚实的基础。

---

### **后续展望**

- 在后续章节中，我们将进一步探讨一致空间的范畴结构，以及如何利用它们来解释更复杂的类型和计算。

- 我们还将研究 **System F** 中的多态类型，以及如何在一致空间的框架下对其进行建模。

---

如果您对本章的内容有任何疑问，或者需要进一步的解释和详细讲解，请随时提出来！

### ---------------------------



### ----------------------------



### ---------------------------



### ----------------------------



### ---------------------------



### ----------------------------



### ---------------------------



### ----------------------------



### ---------------------------



### ----------------------------



### ---------------------------



### ----------------------------